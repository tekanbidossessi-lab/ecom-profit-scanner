
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CHANGED: copy replaced per copywriting PDF (2025-08) — Page Title -->
    <title>Le Scanner de Profit E-com™ — Testez Votre Rentabilité en 60s</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&family=Source+Sans+3:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'heading': ['Montserrat', 'sans-serif'],
                        'body': ['Source Sans 3', 'sans-serif'],
                    },
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#8B5CF6',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        momentumOdark: '#eab023', // Color for 'O' in dark mode
                        momentumOlight: '#00b3be', // Color for 'O' in light mode
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Source Sans 3', sans-serif;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Montserrat', 'sans-serif';
        }
        /* TICKET F: Tabs plus visibles — fort contraste en light & dark */
        .tab-btn {
          padding: 0.75rem 1rem;
          border-radius: 0.5rem;
          transition: transform .12s ease, box-shadow .12s ease;
          font-weight: 700;
          color: #111827; /* dark text on light */
          background: #ffffff;
          border: 1px solid rgba(17,24,39,0.06);
        }
        .tab-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(16,24,40,0.06); }

        /* actif en light */
        .tab-btn.tab-active {
          background: linear-gradient(90deg,#0ea5e9,#6366f1);
          color: #fff;
          box-shadow: 0 8px 30px rgba(79,70,229,0.18);
        }

        /* Dark-mode adjustments — keep contrast */
        .dark .tab-btn {
          background: #0f172a;
          color: #cbd5e1;
          border: 1px solid rgba(255,255,255,0.06);
        }
        .dark .tab-btn.tab-active {
          background: linear-gradient(90deg,#0ea5e9,#6366f1);
          color: #fff;
          box-shadow: 0 8px 30px rgba(99,102,241,0.12);
        }

        .metric-card {
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .dark .metric-card:hover {
             box-shadow: 0 10px 15px -3px rgba(255, 255, 255, 0.1);
        }
        .rating-a { background-color: #10B981; }
        .rating-b { background-color: #3B82F6; }
        .rating-c { background-color: #F59E0B; }
        .rating-d { background-color: #EF4444; }
        .rating-f { background-color: #6B7280; }
        .analysis-question {
            cursor: pointer;
            padding: 1rem;
            background-color: #dbeafe; /* Light blue */
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #1e40af; /* Dark blue */
        }
        .dark .analysis-question {
             background-color: #1e3a8a; /* Darker blue */
             color: #bfdbfe; /* Light blue text */
        }
        .analysis-answer {
            padding: 1rem;
            background-color: #eff6ff; /* Very light blue */
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: none;
        }
        .dark .analysis-answer {
             background-color: #312e81; /* Even darker blue */
        }
        .faq-question {
            cursor: pointer;
            padding: 1rem;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .dark .faq-question {
             background-color: #374151;
        }
        .faq-answer {
            padding: 1rem;
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: none;
        }
        .dark .faq-answer {
             background-color: #4B5563;
        }
        .toggle-dark-mode {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .info-tooltip {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #9CA3AF;
            color: white;
            text-align: center;
            font-size: 12px;
            line-height: 16px;
            cursor: pointer;
            margin-left: 5px;
            position: relative;
        }
        .dark .info-tooltip {
            background-color: #6B7280;
        }
        .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: #1F2937;
            color: #F9FAFB;
            text-align: left;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
            font-weight: normal;
            pointer-events: none;
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1F2937 transparent transparent transparent;
        }
        .info-tooltip:hover .tooltip-text,
        .info-tooltip:focus .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        @media (hover: none) and (pointer: coarse) {
            .info-tooltip .tooltip-text {
                display: none;
            }
            .info-tooltip.active .tooltip-text {
                display: block;
                visibility: visible;
                opacity: 1;
            }
        }
        .detailed-explanation-content {
            background-color: #1E3A8A; /* Dark blue */
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
        }
        .dark .detailed-explanation-content {
            background-color: #3730A3; /* Slightly different dark blue for dark mode */
        }
        .explanation-highlight {
            font-weight: bold;
            color: #FBBF24; /* Amber for highlights */
        }
        .momentum-header {
            font-size: 0.875rem; /* text-sm */
            margin-bottom: 0.5rem;
            color: #0a0e1d;
        }
        .dark .momentum-header {
            color: #FFFFFF;
        }
        /* Styles for new collapsible sections */
        .collapsible-title {
            cursor: pointer;
            display:flex; /* TICKET F */
            align-items:center; /* TICKET F */
            justify-content:space-between; /* TICKET F */
        }
        .collapsible-title .chev { /* TICKET F */
          transition: transform .2s ease;
          margin-left: 12px;
        }
        .collapsible-title.open .chev { /* TICKET F */
          transform: rotate(180deg);
        }
        .collapsible-content {
            display: none;
            margin-top: 1rem;
        }
        /* Ticket F: enforce visible borders for inputs in light mode */
        input, select, textarea {
          border: 1px solid #d1d5db; /* gris clair */
        }
        .dark input,
        .dark select,
        .dark textarea {
          border-color: #374151; /* inchangé en mode sombre */
        }

        /* TICKET 2: FX rate badge CSS */
        #fx-rate-badge {
          font-size: 12px;
          padding: 6px 8px;
          border-radius: 8px;
          background: rgba(0,0,0,0.04);
          color: #111827;
          border: 1px solid rgba(0,0,0,0.06);
          display: inline-block;
        }
        .dark #fx-rate-badge {
          background: rgba(255,255,255,0.04);
          color: #e6eef8;
          border-color: rgba(255,255,255,0.06);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100">
    <div id="app" class="min-h-screen">
        <!-- Dark Mode Toggle -->
        <div class="toggle-dark-mode">
            <button id="dark-mode-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                <svg id="sun-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="moon-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </div>
        <div class="max-w-6xl mx-auto px-4 py-8">
            <!-- Header -->
            <header class="mb-8">
              <div class="flex items-center justify-between max-w-6xl mx-auto px-4">
                <!-- TICKET D: BY MOMENTUM MEDIA is now a clickable link -->
                <a class="momentum-header font-extrabold" href="https://subscribepage.io/momentummedia" target="_blank" rel="noopener">BY M<span class="text-momentumOlight dark:text-momentumOdark">O</span>MENTUM MEDIA</a>
                <div class="flex items-center gap-3">
                  <a href="https://subscribepage.io/momentummedia"
                     target="_blank"
                     rel="noopener"
                     class="px-4 py-2 bg-primary text-white rounded-md">
                     Découvrir Combien je Perds
                  </a>
                  <!-- TICKET 2: FX rate badge -->
                  <span id="fx-rate-badge" class="font-normal">1 USD ≈ 600 FCFA</span>
                </div>
              </div>
              <!-- titre centré en dessous -->
              <div class="text-center mt-6">
                <!-- CHANGED: copy replaced per copywriting PDF (2025-08) — Main Title -->
                <h1 class="text-4xl font-heading font-bold text-primary mb-4 dark:text-blue-400">
                  Le Scanner de Profit E-com™ — Testez Votre Rentabilité en 60s
                </h1>

                <p class="text-lg text-gray-600 max-w-3xl mx-auto dark:text-gray-300">
                  Votre chiffre d’affaires augmente, vos profits diminuent et vous êtes trop chargés pour chercher pourquoi.
                  Entrez vos chiffres pour voir où le cash disparaît, lancez le diagnostic et obtenez 3 actions immédiates pour récupérer vos profits.
                </p>
              </div>
            </header>
            <!-- Tabs -->
            <div class="border-b border-gray-200 mb-8 dark:border-gray-700">
                <nav class="-mb-px flex space-x-8 justify-center">
                    <!-- TICKET 2: Renommer les labels et appliquer le style des onglets -->
                    <button id="meta-tab" class="tab-btn tab-active" onclick="switchTab('meta')">Acquisition Clientèle</button>
                    <button id="shopify-tab" class="tab-btn" onclick="switchTab('shopify')">Systèmes & Profit</button>
                </nav>
            </div>
            <!-- Meta Ads Tab -->
            <div id="meta-tab-content" class="tab-content">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8 dark:bg-gray-800 dark:shadow-gray-700/50">
                    <!-- CHANGED: copy replaced per copywriting PDF (2025-08) — Tab 1 Title -->
                    <h2 class="text-2xl font-bold font-heading mb-6 text-primary dark:text-blue-400">Diagnostic Acquisition Clientèle</h2>
                    <!-- Meta Inputs -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <!-- CHANGED: copy replaced per copywriting PDF (2025-08) — Labels & Tooltips -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Période <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Sur combien de jours voulez-vous faire le diagnostic? (7, 30, 90)</span></span></label>
                            <select id="meta-period" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="7">7 Jours</option>
                                <option value="30" selected>30 Jours</option>
                                <option value="90">90 Jours</option>
                                <option value="365">365 Jours</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Budget Pubs (USD) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le cash total que vous avez investi pour acquérir des clients.</span></span></label>
                            <input type="number" id="meta-ad-spend" placeholder="ex : 800" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Impressions <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le nombre de fois où des gens ont vu vos pubs (sans forcément cliquer).</span></span></label>
                            <input type="number" id="meta-impressions" placeholder="ex : 200000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <!-- TICKET 4: Renommer label "Clics" → "Taux de Clics (Clics)" -->
                            <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Taux de Clics (Clics) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le nombre de personnes qui ont cliqué sur vos pubs.</span></span></label>
                            <input type="number" id="meta-clicks" placeholder="ex : 8000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <!-- TICKET 5: Supprimé les inputs CPC et CPA -->
                    </div>
                    <!-- Conversion Type -->
                    <div class="mb-8">
                        <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Où la vente se fait-elle ? <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Est-ce que vos pubs envoient vers WhatsApp ou une page produit Shopify ?</span></span></label>
                        <select id="meta-conversion-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white" onchange="toggleConversionFields()">
                            <option value="">Sélectionnez le Type de Conversion</option>
                            <option value="whatsapp">WhatsApp</option>
                            <option value="shopify">Shopify</option>
                        </select>
                    </div>
                    <!-- WhatsApp Conversion Fields -->
                    <div id="whatsapp-fields" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Conversations Initiées <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Combien de personnes ont ouvert une discussion WhatsApp.</span></span></label>
                            <input type="number" id="whatsapp-conversations" placeholder="ex : 1500" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Ventes Via WhatsApp <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Sur toutes ces discussions, combien ont réellement acheté ?</span></span></label>
                            <input type="number" id="whatsapp-conversions" placeholder="ex : 300" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Prix du Produit (FCFA) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le prix de vente de votre produit principal sur WhatsApp.</span></span></label>
                            <input type="number" id="whatsapp-product-price" placeholder="ex : 15000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                         <!-- Upsells Question -->
                        <div id="whatsapp-upsells-question" class="hidden mb-6 md:col-span-2">
                            <div class="flex items-center">
                                <input type="checkbox" id="whatsapp-has-upsells" class="h-5 w-5 text-primary rounded focus:ring-primary dark:bg-gray-700 dark:border-gray-600" onchange="toggleWhatsappUpsellDropdown()">
                                <!-- CHANGED: copy replaced per copywriting PDF (2025-08) — Checkbox Label -->
                                <label for="whatsapp-has-upsells" class="ml-3 text-gray-700 font-medium dark:text-gray-300">[✓] J'ai un système d'Upsell/Downsell/Cross-Sell en place.</label>
                            </div>
                        </div>
                        <!-- Upsell Dropdown -->
                        <div id="whatsapp-upsell-dropdown" class="hidden md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Sélectionnez le Pourcentage d'Adoption des Upsells</label>
                            <select id="whatsapp-upsell-percentage" class="w-full md:w-1/2 px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="0.025">2.5%</option>
                                <option value="0.05">5%</option>
                                <option value="0.075">7.5%</option>
                                <option value="0.1" selected>10%</option>
                                <option value="0.15">15%</option>
                                <option value="0.2">20%</option>
                                <option value="0.25">25%</option>
                                <option value="0.3">30%</option>
                            </select>
                        </div>
                        <!-- TICKET C: Upsell Price Input (Meta - WhatsApp) -->
                        <div id="whatsapp-upsell-price-input" class="hidden mb-4">
                          <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">
                            Prix moyen des Upsells, downsells et/ou cross-sells (FCFA)
                            <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le prix moyen d'un produit vendu via upsell. Par défaut, 50% du prix produit.</span></span>
                          </label>
                          <input type="number" id="whatsapp-upsell-average-price" placeholder="ex : 7500" class="w-full md:w-1/2 px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                    </div>
                    <!-- Shopify Conversion Fields -->
                    <div id="shopify-fields" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Nombre de Commandes (Shopify) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le nombre de commandes passées sur votre site via ces pubs.</span></span></label>
                            <input type="number" id="shopify-orders" placeholder="ex : 250" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Prix du Produit (FCFA) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le prix de vente de votre produit principal sur Shopify.</span></span></label>
                            <input type="number" id="shopify-product-price-meta" placeholder="ex : 15000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                         <!-- Upsells Question -->
                        <div id="shopify-upsells-question-meta" class="hidden mb-6 md:col-span-2">
                            <div class="flex items-center">
                                <input type="checkbox" id="shopify-has-upsells-meta" class="h-5 w-5 text-primary rounded focus:ring-primary dark:bg-gray-700 dark:border-gray-600" onchange="toggleShopifyUpsellDropdownMeta()">
                                <!-- CHANGED: copy replaced per copywriting PDF (2025-08) — Checkbox Label -->
                                <label for="shopify-has-upsells-meta" class="ml-3 text-gray-700 font-medium dark:text-gray-300">[✓] J'ai un système d'Upsell/Downsell/Cross-Sell en place.</label>
                            </div>
                        </div>
                        <!-- Upsell Dropdown -->
                        <div id="shopify-upsell-dropdown-meta" class="hidden md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Sélectionnez le Pourcentage d'Adoption des Upsells</label>
                            <select id="shopify-upsell-percentage-meta" class="w-full md:w-1/2 px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="0.025">2.5%</option>
                                <option value="0.05">5%</option>
                                <option value="0.075">7.5%</option>
                                <option value="0.1" selected>10%</option>
                                <option value="0.15">15%</option>
                                <option value="0.2">20%</option>
                                <option value="0.25">25%</option>
                                <option value="0.3">30%</option>
                            </select>
                        </div>
                        <!-- TICKET C: Upsell Price Input (Meta - Shopify conversion) -->
                        <div id="shopify-upsell-price-input-meta" class="hidden mb-4">
                          <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">
                            Prix moyen des Upsells, downsells et/ou cross-sells (FCFA)
                            <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le prix moyen d'un produit vendu via upsell. Par défaut, 50% du prix produit.</span></span>
                          </label>
                          <input type="number" id="shopify-upsell-average-price-meta" placeholder="ex : 7500" class="w-full md:w-1/2 px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                    </div>
                    <!-- Email/WhatsApp Marketing Question (TICKET 6: hidden in this tab) -->
                    <div id="email-whatsapp-question-meta" class="hidden mb-6">
                        <div class="flex items-center">
                            <input type="checkbox" id="meta-has-email-whatsapp" class="h-5 w-5 text-primary rounded focus:ring-primary dark:bg-gray-700 dark:border-gray-600" onchange="toggleMetaEmailWhatsAppDropdown()">
                            <!-- CHANGED: copy replaced per copywriting PDF (2025-08) — Checkbox Label -->
                            <label for="meta-has-email-whatsapp" class="ml-3 text-gray-700 font-medium dark:text-gray-300">[✓] J'utilise l'Email/WhatsApp pour la relance et la fidélisation.</label>
                            </div>
                        </div>
                     <!-- Email/WhatsApp Marketing Dropdown (TICKET 6: hidden in this tab) -->
                    <div id="meta-email-whatsapp-dropdown" class="hidden mb-8">
                        <!-- CHANGED: copy replaced per copywriting PDF (2025-08) — Section Title & Labels -->
                        <h4 class="font-medium text-gray-700 mb-4 dark:text-gray-300">Systèmes de Rétention & Maximisation</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gray-100 p-4 rounded-lg dark:bg-gray-700/50">
                                <h5 class="text-gray-700 font-medium mb-3 dark:text-gray-300">Email Marketing</h5>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">Taille actuelle de la liste <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le nombre total d'abonnés sur votre liste Email active.</span></span></label>
                                        <input type="number" id="meta-email-list-size" placeholder="ex : 1000" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">Taux d'inscription Pop-up (%) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le pourcentage de personnes qui voient votre pop-up Email et s'inscrivent. Benchmark minimum : 10%.</span></span></label>
                                        <input type="number" id="meta-email-popup-rate" placeholder="ex : 8" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">Taux d'Ouverture moyen (%) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le pourcentage de personnes qui ouvrent vos Emails. Benchmark minimum : 45%.</span></span></label>
                                        <input type="number" id="meta-email-open-rate" placeholder="ex : 30" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">CTR des flux automatisés (%) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le taux de clics moyen sur vos flux automatisés (Bienvenue, Abandon Panier, etc.). Benchmark : 1%.</span></span></label>
                                        <input type="number" id="meta-email-click-flow-rate" placeholder="ex : 1" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">CTR des campagnes manuelles (%) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le taux de clics moyen sur vos campagnes manuelles. Benchmark : 2.5%.</span></span></label>
                                        <input type="number" id="meta-email-click-campaign-rate" placeholder="ex : 2.5" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">Campagnes par semaine <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Combien de campagnes manuelles envoyez-vous par semaine ?</span></span></label>
                                        <input type="number" id="meta-email-campaigns-per-week" placeholder="ex : 2" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-100 p-4 rounded-lg dark:bg-gray-700/50">
                                <h5 class="text-gray-700 font-medium mb-3 dark:text-gray-300">WhatsApp Marketing</h5>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">Taille actuelle de la liste <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le nombre total de contacts dans votre liste WhatsApp active.</span></span></label>
                                        <input type="number" id="meta-whatsapp-list-size" placeholder="ex : 1500" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">Taux d'inscription Pop-up (%) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le pourcentage de personnes qui voient votre pop-up WhatsApp et s'inscrivent. Benchmark minimum : 10%.</span></span></label>
                                        <input type="number" id="meta-whatsapp-popup-rate" placeholder="ex : 12" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">Taux d'Ouverture moyen (%) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le pourcentage de personnes qui ouvrent vos messages WhatsApp (ex: taux de lecture). Benchmark minimum : 45%.</span></span></label>
                                        <input type="number" id="meta-whatsapp-open-rate" placeholder="ex : 50" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">CTR des flux automatisés (%) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le taux de clics moyen sur vos flux automatisés WhatsApp. Benchmark : 1%.</span></span></label>
                                        <input type="number" id="meta-whatsapp-click-flow-rate" placeholder="ex : 1.5" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">CTR des campagnes manuelles (%) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le taux de clics moyen sur vos campagnes WhatsApp manuelles. Benchmark : 2.5%.</span></span></label>
                                        <input type="number" id="meta-whatsapp-click-campaign-rate" placeholder="ex : 3" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">Campagnes par semaine <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Combien de campagnes WhatsApp manuelles envoyez-vous par semaine ?</span></span></label>
                                        <input type="number" id="meta-whatsapp-campaigns-per-week" placeholder="ex : 1" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Calculate Button -->
                    <div class="text-center">
                        <!-- CHANGED: copy replaced per copywriting PDF (2025-08) — Main Button -->
                        <button onclick="calculateMetaResults()" class="px-8 py-3 bg-primary text-white font-bold rounded-lg shadow hover:bg-blue-700 transition-colors dark:bg-blue-600 dark:hover:bg-blue-700">
                            Lancer le Diagnostic
                        </button>
                    </div>
                </div>
                <!-- Meta Results -->
                <div id="meta-results" class="hidden bg-white rounded-xl shadow-lg p-6 dark:bg-gray-800 dark:shadow-gray-700/50">
                    <h2 class="text-2xl font-bold font-heading mb-6 text-primary dark:text-blue-400">Résultats de l'Analyse Meta Ads</h2>

                    <!-- Total Revenue Summary -->
                    <div class="mb-8 p-4 bg-gradient-to-r from-primary to-secondary rounded-lg text-white">
                        <p class="text-lg mb-2">Revenus Totaux Potentiels :</p>
                        <p id="meta-total-revenue" class="text-3xl font-bold">0 FCFA</p>
                        <p class="text-sm mt-2">Cela inclut vos ventes directes et le potentiel de vos upsells.</p>
                    </div>

                    <!-- Key Metrics -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                        <div class="metric-card bg-blue-50 p-4 rounded-lg text-center dark:bg-blue-900/30">
                            <p class="text-sm text-gray-600 dark:text-gray-300">Taux de Clics (CTR)</p>
                            <p id="meta-ctr" class="text-xl font-bold">0.00%</p>
                            <p id="meta-ctr-desc" class="text-xs text-gray-500 dark:text-gray-400 mt-1">Ratio clics/impressions</p>
                        </div>
                        <div class="metric-card bg-green-50 p-4 rounded-lg text-center dark:bg-green-900/30">
                            <p class="text-sm text-gray-600 dark:text-gray-300">Taux de Conversion</p>
                            <p id="meta-conv-rate" class="text-xl font-bold">0.00%</p>
                            <p id="meta-conv-rate-desc" class="text-xs text-gray-500 dark:text-gray-400 mt-1">Ratio conversions/clics</p>
                        </div>
                        <div class="metric-card bg-yellow-50 p-4 rounded-lg text-center dark:bg-yellow-900/30">
                            <p class="text-sm text-gray-600 dark:text-gray-300">Retour sur Dépense Publicitaire (ROAS)</p>
                            <p id="meta-roas" class="text-xl font-bold">0.00x</p>
                            <p id="meta-roas-desc" class="text-xs text-gray-500 dark:text-gray-400 mt-1">Revenus générés pour 1 FCFA dépensé</p>
                        </div>
                        <!-- TICKET 8: Replaced Marge brute with Coût Par Acquisition (CPA) -->
                        <div class="metric-card bg-purple-50 p-4 rounded-lg text-center dark:bg-purple-900/30">
                            <p class="text-sm text-gray-600 dark:text-gray-300">Coût Par Acquisition (CPA)</p>
                            <p id="meta-cpa-display" class="text-xl font-bold">0.00 USD</p>
                            <p id="meta-cpa-desc" class="text-xs text-gray-500 dark:text-gray-400 mt-1">Le coût pour acquérir une commande</p>
                        </div>
                    </div>
                    <!-- Performance Analysis -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold mb-4 dark:text-gray-200">Analyse de Performance</h3>
                        <div id="meta-analysis" class="space-y-4">
                            <!-- Analysis will be populated here by JS (TICKET 9) -->
                        </div>
                    </div>
                    <!-- Benchmark Comparison -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold mb-4 dark:text-gray-200">Comparaison avec les Valeurs de Référence</h3>
                        <div id="benchmark-comparison" class="space-y-4">
                            <!-- Benchmark comparison will be populated here -->
                        </div>
                    </div>
                    <!-- Issues & Recommendations -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold mb-4 dark:text-gray-200">Problèmes & Recommandations</h3>
                        <div id="meta-recommendations" class="space-y-4">
                            <!-- Recommendations will be populated here -->
                        </div>
                    </div>
                    <!-- CTA to Shopify Tab -->
                    <div class="text-center py-6">
                        <p class="text-lg mb-4 dark:text-gray-300">Obtenez des résultats plus approfondis en analysant vos performances Shopify</p>
                        <button onclick="switchTab('shopify')" class="px-6 py-3 bg-accent text-white font-medium rounded-lg shadow hover:bg-purple-700 transition-colors dark:bg-purple-600 dark:hover:bg-purple-700">
                            Continuer vers l'Analyse Shopify
                        </button>
                    </div>
                </div>
            </div>
            <!-- Shopify Tab -->
            <div id="shopify-tab-content" class="tab-content hidden">
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8 dark:bg-gray-800 dark:shadow-gray-700/50">
                     <!-- CHANGED: copy replaced per copywriting PDF (2025-08) — Tab 2 Title -->
                    <h2 class="text-2xl font-bold font-heading mb-6 text-primary dark:text-blue-400">Diagnostic Systèmes & Profit</h2>
                    <!-- Shopify Inputs -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Période <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">La période sur laquelle vos données de performance sont basées (7, 30, 90 ou 365 jours).</span></span></label>
                            <select id="shopify-period" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="7">7 Jours</option>
                                <option value="30" selected>30 Jours</option>
                                <option value="90">90 Jours</option>
                                <option value="365">365 Jours</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Budget Pubs (USD) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le montant total dépensé en publicités (Meta, Google, etc.) pendant la période.</span></span></label>
                            <input type="number" id="shopify-ad-spend" placeholder="ex : 800" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Sessions de Visiteurs <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le nombre total de sessions uniques sur votre site Shopify.</span></span></label>
                            <input type="number" id="shopify-sessions" placeholder="ex : 50000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Nombre de Commandes <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le nombre total de commandes passées sur votre boutique pendant la période.</span></span></label>
                            <input type="number" id="shopify-orders-tab2" placeholder="ex : 1250" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Commandes Expédiées/Livrées <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le nombre de commandes qui ont été effectivement livrées et payées.</span></span></label>
                            <input type="number" id="shopify-fulfilled-orders" placeholder="ex : 1100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Prix du Produit sur la Boutique (FCFA) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le prix de vente final de votre produit sur votre boutique Shopify.</span></span></label>
                            <input type="number" id="shopify-product-price-tab2" placeholder="ex : 15000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Coût du Produit à l'Achat (FCFA) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le prix que vous payez pour acheter ou fabriquer un seul produit.</span></span></label>
                            <input type="number" id="shopify-product-cost" placeholder="ex : 8000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Frais de Port (FCFA) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Les frais totaux pour expédier vos produits de votre fournisseur vers vous.</span></span></label>
                            <input type="number" id="shopify-shipping-fee" placeholder="ex : 2000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Nombre de Produits Achats <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le nombre total de produits que vous avez achetés ou commandés pendant cette période.</span></span></label>
                            <input type="number" id="shopify-products-bought" placeholder="ex : 1500" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Frais de Livraison (FCFA) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le coût moyen de la livraison finale du colis au client.</span></span></label>
                            <input type="number" id="shopify-delivery-fee" placeholder="ex : 1500" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                    </div>
                    <!-- Upsells Question -->
                    <div class="mb-6">
                        <div class="flex items-center">
                            <input type="checkbox" id="shopify-has-upsells" class="h-5 w-5 text-primary rounded focus:ring-primary dark:bg-gray-700 dark:border-gray-600" onchange="toggleShopifyUpsellDropdown()">
                             <!-- CHANGED: copy replaced per copywriting PDF (2025-08) — Checkbox Label -->
                            <label for="shopify-has-upsells" class="ml-3 text-gray-700 font-medium dark:text-gray-300">[✓] J'ai un système d'Upsell/Downsell/Cross-Sell en place.</label>
                        </div>
                    </div>
                    <!-- Shopify Upsell Dropdown -->
                    <div id="shopify-upsell-dropdown" class="hidden mb-8">
                        <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Sélectionnez le Pourcentage d'Adoption des Upsells</label>
                        <select id="shopify-upsell-percentage" class="w-full md:w-1/2 px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="2.5">2.5%</option>
                            <option value="5">5%</option>
                            <option value="7.5">7.5%</option>
                            <option value="10" selected>10%</option>
                            <option value="15">15%</option>
                            <option value="20">20%</option>
                            <option value="25">25%</option>
                            <option value="30">30%</option>
                        </select>
                    </div>
                    <!-- Upsell Price Input -->
                    <div id="shopify-upsell-price-input" class="hidden mb-8">
                        <label class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Prix moyen des Upsells, downsells et/ou cross-sells (FCFA) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le prix moyen d'un produit vendu via upsell, downsell ou cross-sell. Par défaut, 50% du prix du produit principal.</span></span></label>
                        <input type="number" id="shopify-upsell-average-price" placeholder="ex : 7500" class="w-full md:w-1/2 px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    <!-- Email/WhatsApp Marketing Question -->
                    <div class="mb-6">
                        <div class="flex items-center">
                            <input type="checkbox" id="shopify-has-email-whatsapp" class="h-5 w-5 text-primary rounded focus:ring-primary dark:bg-gray-700 dark:border-gray-600" onchange="toggleShopifyEmailWhatsAppDropdown()">
                            <!-- CHANGED: copy replaced per copywriting PDF (2025-08) — Checkbox Label -->
                            <label for="shopify-has-email-whatsapp" class="ml-3 text-gray-700 font-medium dark:text-gray-300">[✓] J'utilise l'Email/WhatsApp pour la relance et la fidélisation.</label>
                        </div>
                    </div>
                    <!-- Email/WhatsApp Marketing Dropdown -->
                    <div id="shopify-email-whatsapp-dropdown" class="hidden mb-8">
                         <!-- CHANGED: copy replaced per copywriting PDF (2025-08) — Section Title & Labels -->
                        <h4 class="font-medium text-gray-700 mb-4 dark:text-gray-300">Systèmes de Rétention & Maximisation</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gray-100 p-4 rounded-lg dark:bg-gray-700/50">
                                <h5 class="text-gray-700 font-medium mb-3 dark:text-gray-300">Email Marketing</h5>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">Taille actuelle de la liste <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le nombre total d'abonnés sur votre liste Email active.</span></span></label>
                                        <input type="number" id="email-list-size" placeholder="ex : 1000" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">Taux d'inscription Pop-up (%) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le pourcentage de personnes qui voient votre pop-up Email et s'inscrivent. Benchmark minimum : 10%.</span></span></label>
                                        <input type="number" id="email-popup-rate" placeholder="ex : 8" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">Taux d'Ouverture moyen (%) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le pourcentage de personnes qui ouvrent vos Emails. Benchmark minimum : 45%.</span></span></label>
                                        <input type="number" id="email-open-rate" placeholder="ex : 30" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">CTR des flux automatisés (%) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le taux de clics moyen sur vos flux automatisés (Bienvenue, Abandon Panier, etc.). Benchmark : 1%.</span></span></label>
                                        <input type="number" id="email-click-flow-rate" placeholder="ex : 1" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">CTR des campagnes manuelles (%) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le taux de clics moyen sur vos campagnes manuelles. Benchmark : 2.5%.</span></span></label>
                                        <input type="number" id="email-click-campaign-rate" placeholder="ex : 2.5" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">Campagnes par semaine <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Combien de campagnes manuelles envoyez-vous par semaine ?</span></span></label>
                                        <input type="number" id="email-campaigns-per-week" placeholder="ex : 2" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <input type="hidden" id="estimated-email-revenue" value="0"> <!-- Added for Patch B -->
                                </div>
                            </div>
                            <div class="bg-gray-100 p-4 rounded-lg dark:bg-gray-700/50">
                                <h5 class="text-gray-700 font-medium mb-3 dark:text-gray-300">WhatsApp Marketing</h5>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">Taille actuelle de la liste <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le nombre total de contacts dans votre liste WhatsApp active.</span></span></label>
                                        <input type="number" id="whatsapp-list-size" placeholder="ex : 1500" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <!-- TICKET E: Infobulle pour Taille de la nouvelle liste -->
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">Taux d'inscription Pop-up (%) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Taille actuelle de la liste (Email + WhatsApp) + nouvelles inscriptions estimées via popups (selon le taux de popup et sessions).</span></span></label>
                                        <input type="number" id="whatsapp-popup-rate" placeholder="ex : 12" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">Taux d'Ouverture moyen (%) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le pourcentage de personnes qui ouvrent vos messages WhatsApp (ex: taux de lecture). Benchmark minimum : 45%.</span></span></label>
                                        <input type="number" id="whatsapp-open-rate" placeholder="ex : 50" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">CTR des flux automatisés (%) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le taux de clics moyen sur vos flux automatisés WhatsApp. Benchmark : 1%.</span></span></label>
                                        <input type="number" id="whatsapp-click-flow-rate" placeholder="ex : 1.5" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <!-- TICKET D: Tooltip manual campaign -->
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">CTR des campagnes manuelles (%) <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Estimation des ventes générées par vos campagnes manuelles (emails et WhatsApp ciblés).</span></span></label>
                                        <input type="number" id="whatsapp-click-campaign-rate" placeholder="ex : 3" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1 dark:text-gray-400">Campagnes par semaine <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Combien de campagnes WhatsApp manuelles envoyez-vous par semaine ?</span></span></label>
                                        <input type="number" id="whatsapp-campaigns-per-week" placeholder="ex : 1" class="w-full px-3 py-2 border border-gray-300 rounded text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    </div>
                                    <input type="hidden" id="estimated-whatsapp-revenue" value="0"> <!-- Added for Patch B -->
                                    <input type="hidden" id="recovered-cancelled-revenue" value="0"> <!-- Added for Patch B -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Calculate Button -->
                    <div class="text-center">
                        <!-- CHANGED: copy replaced per copywriting PDF (2025-08) — Main Button -->
                        <button onclick="calculateShopifyResults()" class="px-8 py-3 bg-primary text-white font-bold rounded-lg shadow hover:bg-blue-700 transition-colors dark:bg-blue-600 dark:hover:bg-blue-700">
                            Lancer le Diagnostic
                        </button>
                    </div>
                </div>
                <!-- Shopify Results -->
                <div id="shopify-results" class="hidden bg-white rounded-xl shadow-lg p-6 dark:bg-gray-800 dark:shadow-gray-700/50">
                    <h2 class="text-2xl font-bold font-heading mb-6 text-primary dark:text-blue-400">Résultats de l'Analyse Shopify</h2>

                    <!-- Shared Results Banner (TICKET 7) -->
                    <div id="shared-results-banner"></div>

                    <!-- Chiffre d'affaire Summary -->
                    <div class="mb-8 p-4 bg-gradient-to-r from-primary to-secondary rounded-lg text-white">
                        <p class="text-lg mb-2">Chiffre d'affaires Mensuel :</p>
                        <p id="shopify-monthly-revenue" class="text-3xl font-bold">0 FCFA</p>
                        <p class="text-sm mt-2">(Commandes Expédiées * Prix du Produit)</p>
                    </div>

                    <!-- Shopify Metrics -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8"> <!-- TICKET K: Added a column for Taux d'Annulation -->
                        <div class="metric-card bg-blue-50 p-4 rounded-lg text-center dark:bg-blue-900/30">
                            <p class="text-sm text-gray-600 dark:text-gray-300">Taux de Conversion</p>
                            <p id="shopify-conv-rate" class="text-xl font-bold">0.00%</p>
                            <p id="shopify-conv-rate-desc" class="text-xs text-gray-500 dark:text-gray-400 mt-1">Commandes/Sessions</p>
                        </div>
                        <div class="metric-card bg-green-50 p-4 rounded-lg text-center dark:bg-green-900/30">
                            <p class="text-sm text-gray-600 dark:text-gray-300">Bénéfice Net</p>
                            <p id="shopify-net-profit" class="text-xl font-bold">0 FCFA</p>
                            <p id="shopify-net-profit-desc" class="text-xs text-gray-500 dark:text-gray-400 mt-1">Revenus - Coûts - Publicité</p>
                        </div>
                        <div class="metric-card bg-purple-50 p-4 rounded-lg text-center dark:bg-purple-900/30">
                            <p class="text-sm text-gray-600 dark:text-gray-300">Marge Bénéficiaire</p>
                            <p id="shopify-margin" class="text-xl font-bold">0.00%</p>
                            <p id="shopify-margin-desc" class="text-xs text-gray-500 dark:text-gray-400 mt-1">Bénéfice/Revenus</p>
                        </div>
                        <!-- TICKET K: Added Taux d'Annulation metric -->
                        <div class="metric-card bg-red-50 p-4 rounded-lg text-center dark:bg-red-900/20">
                          <p class="text-sm text-gray-600 dark:text-gray-300">Taux d'Annulation</p>
                          <p id="shopify-cancellation-rate" class="text-xl font-bold">0.00%</p>
                          <p id="shopify-cancellation-desc" class="text-xs text-gray-500 dark:text-gray-400 mt-1">Commandes annulées / Commandes reçues</p>
                        </div>
                    </div>

                    <!-- TICKET C: Moved Order Analysis above Performance Analysis -->
                    <div id="shopify-order-analysis" class="mb-8">
                      <h3 class="text-xl font-semibold mb-4 dark:text-gray-200">Analyse des Commandes</h3>
                      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                          <div class="bg-gray-50 p-4 rounded-lg dark:bg-gray-700">
                              <p class="text-gray-600 dark:text-gray-300">Commandes Annulées</p>
                              <p id="cancelled-orders" class="text-2xl font-bold text-danger">0</p>
                              <p id="cancelled-orders-desc" class="text-xs text-gray-500 dark:text-gray-400 mt-1">Commandes non livrées</p>
                          </div>
                          <div class="bg-gray-50 p-4 rounded-lg dark:bg-gray-700">
                              <p class="text-gray-600 dark:text-gray-300">Perte liée aux Annulations</p>
                              <p id="cancellation-loss" class="text-2xl font-bold text-danger">0 FCFA</p>
                              <p id="cancellation-loss-desc" class="text-xs text-gray-500 dark:text-gray-400 mt-1">Revenus perdus</p>
                          </div>
                          <div class="bg-gray-50 p-4 rounded-lg dark:bg-gray-700">
                              <p class="text-gray-600 dark:text-gray-300">Coût de Traitement <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Coût total pour préparer et expédier une commande.</span></span></label>
                              <p id="fulfillment-cost" class="text-2xl font-bold">0 FCFA</p>
                              <p id="fulfillment-cost-orders" class="text-xs text-gray-500 dark:text-gray-400 mt-1">Pour <span id="fulfilled-orders-display">0</span> commandes expédiées</p>
                          </div>
                           <div class="bg-gray-50 p-4 rounded-lg dark:bg-gray-700">
                              <p class="text-gray-600 dark:text-gray-300">Perte Potentielle <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Le manque à gagner dû aux commandes annulées et aux coûts associés.</span></span></p>
                              <p id="potential-loss" class="text-2xl font-bold text-danger">0 FCFA</p>
                              <p id="potential-loss-desc" class="text-xs text-gray-500 dark:text-gray-400 mt-1">Perte totale par commande annulée</p>
                          </div>
                      </div>
                    </div>
                    <!-- Performance Analysis -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold mb-4 dark:text-gray-200">Analyse de Performance</h3>
                        <div id="shopify-analysis" class="space-y-4">
                            <!-- Analysis will be populated here -->
                        </div>
                    </div>
                    <!-- COÛT D'ACQUISITION CLIENT (CAC) - collapsible & coloré (TICKET 17 / E) -->
                    <div id="cac-block" class="mt-6">
                      <div class="p-4 bg-indigo-50 rounded-lg dark:bg-indigo-900/20">
                        <h4 class="font-bold text-indigo-700 dark:text-indigo-300 collapsible-title" onclick="toggleCollapsible(this)">
                          <span>Coût d'Acquisition Client (CAC)</span>
                          <svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </h4>
                        <div class="collapsible-content" style="display:none;"> <!-- TICKET E: changed to display:none -->
                          <p id="cac-copy-intro" class="mt-2 text-sm text-gray-700 dark:text-gray-300">
                            Pour <span id="cac-orders-count" class="font-semibold">X</span> commandes, vous avez dépensé <span id="cac-adspend" class="font-semibold">Z USD</span> en publicités.
                          </p>

                          <div class="mt-3 p-3 bg-white rounded shadow-sm dark:bg-gray-800">
                            <p class="text-sm text-gray-600">Résultat :</p>
                            <p class="text-2xl font-extrabold" id="cac-value-display">0.00 USD</p>
                            <p class="text-xs text-gray-500 mt-1">Le coût moyen pour acquérir un client pendant la période choisie.</p>
                          </div>

                          <div class="mt-3 p-3 bg-white rounded shadow-sm dark:bg-gray-800">
                            <p class="text-sm text-gray-600">Profit net moyen par client :</p>
                            <p id="cac-profit-per-customer" class="text-lg font-bold">0 FCFA</p>
                          </div>

                          <div class="mt-3">
                            <p id="cac-assessment" class="text-sm text-gray-700 dark:text-gray-300">
                              <!-- copywriting convainquant injecté par JS -->
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Revenue Breakdown (Potentiel du tunnel vente) -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold mb-4 dark:text-gray-200">Potentiel du tunnel vente</h3>
                        <div id="revenue-breakdown-content">
                            <!-- Content will be populated by JS -->
                        </div>
                        <!-- CHANGED: copy replaced per copywriting PDF (2025-08) — Explanation Box 1 -->
                        <div id="revenue-breakdown-explanation" class="mt-4">
                            <div class="analysis-question collapsible-title" onclick="toggleCollapsible(this)">
                                <span>Comment est calculé le "Potentiel du Tunnel" ?</span>
                                <svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </div>
                            <div class="analysis-answer detailed-explanation-content">
                                <p class="text-sm">C'est la différence entre votre chiffre d'affaires actuel et celui que vous pourriez atteindre avec un système d'offres complémentaires (upsells, order bumps). C'est le cash le plus facile à obtenir car il ne nécessite pas de nouvelles dépenses publicitaires.</p>
                            </div>
                        </div>
                    </div>
                    <!-- Email/WhatsApp Marketing -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold mb-4 dark:text-gray-200">Potentiel du Marketing Email & WhatsApp</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-gray-50 p-4 rounded-lg dark:bg-gray-700">
                                <p class="text-gray-600 dark:text-gray-300">Taille de la nouvelle liste <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Estimation du nombre d’abonnés que vous aurez après la période choisie (nombre actuel + inscriptions attendues via pop-ups).</span></span></p>
                                <p id="new-list-size" class="text-xl font-bold">0</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg dark:bg-gray-700">
                                <p class="text-gray-600 dark:text-gray-300">Revenue de Campagne manuel <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Estimation des ventes générées par vos campagnes manuelles (emails et WhatsApp ciblés).</span></span></p>
                                <p id="manual-campaign-revenue" class="text-xl font-bold text-green-600 dark:text-green-400">0 FCFA</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg dark:bg-gray-700">
                                <p class="text-gray-600 dark:text-gray-300">Revenue de flux automatisé <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Estimation des ventes générées automatiquement par vos flows (abandon panier, welcome).</span></span></p>
                                <p id="automated-flow-revenue" class="text-xl font-bold text-green-600 dark:text-green-400">0 FCFA</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg dark:bg-gray-700">
                                <p class="text-gray-600 dark:text-gray-300">Revenue total <span class="info-tooltip" tabindex="0">i<span class="tooltip-text">Total attendu des revenus Email & WhatsApp sur la période sélectionnée.</span></span></label>
                                <p id="email-whatsapp-total-revenue" class="text-xl font-bold text-green-600 dark:text-green-400">0 FCFA</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="analysis-question collapsible-title" onclick="toggleCollapsible(this)">
                                <!-- TICKET D: Texte de calcul en haut -->
                                <span>Interprétation de votre potentiel Email & WhatsApp</span>
                                <svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </div>
                             <div class="analysis-answer detailed-explanation-content">
                                <p class="text-sm font-semibold">Calcul rapide : (Taille liste actuelle + Nouvelles inscriptions via popups) × Taux d'ouverture × Taux de clic × Taux de conversion × Prix moyen produit (+ upsells si activés).</p>
                                <p class="text-sm mt-2">Ces chiffres montrent à quel point vos listes Email et WhatsApp peuvent devenir une véritable machine à générer des ventes récurrentes. En automatisant la communication et en lançant des campagnes ciblées, vous créez une source de revenus stable qui ne dépend pas de nouvelles dépenses publicitaires. C'est un levier essentiel pour augmenter votre rentabilité et la valeur de chaque client sur le long terme.</p>
                            </div>
                        </div>
                    </div>
                    <!-- Performance Ratings -->
                    <div class="mb-8">
                        <h3 class="text-xl font-semibold mb-4 dark:text-gray-200">Évaluations de Performance</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div id="popup-rating" class="metric-card p-4 rounded-lg text-center text-white">
                                <p class="text-sm">Conversion Pop-up</p>
                                <p class="text-lg font-bold">Note: F</p>
                                <p id="popup-rating-desc" class="text-xs mt-1">Taux de conversion du pop-up</p>
                            </div>
                            <div id="ctr-rating" class="metric-card p-4 rounded-lg text-center text-white">
                                <p class="text-sm">Taux de Conversion</p>
                                <p class="text-lg font-bold">Note: F</p>
                                <p id="ctr-rating-desc" class="text-xs mt-1">Commandes/Sessions</p>
                            </div>
                            <div id="open-rate-rating" class="metric-card p-4 rounded-lg text-center text-white">
                                <p class="text-sm">Taux d'Ouverture Email</p>
                                <p class="text-lg font-bold">Note: F</p>
                                <p id="open-rate-rating-desc" class="text-xs mt-1">Qualité de la liste email</p>
                            </div>
                             <div id="upsell-rating" class="metric-card p-4 rounded-lg text-center text-white">
                                <p class="text-sm">Performance des Upsells</p>
                                <p class="text-lg font-bold">Note: F</p>
                                <p id="upsell-rating-desc" class="text-xs mt-1">Revenus générés</p>
                            </div>
                        </div>
                         <!-- CHANGED: copy replaced per copywriting PDF (2025-08) — Explanation Box 2 -->
                         <div id="ratings-explanation" class="mt-4">
                            <div class="analysis-question collapsible-title" onclick="toggleCollapsible(this)">
                                <span>À quoi correspondent ces notes (A, B, C...) ?</span>
                                <svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </div>
                            <div class="analysis-answer detailed-explanation-content">
                                <p>C'est une évaluation brutale de vos systèmes.</p>
                                <ul class="list-disc pl-5 text-sm space-y-1 mt-2">
                                    <li><span class="font-bold">A :</span> Votre système est solide, félicitations.</li>
                                    <li><span class="font-bold">B :</span> Votre système est bon, à un pas de l'excellence.</li>
                                    <li><span class="font-bold">C :</span> Votre système est moyen. Il y a des fuites.</li>
                                    <li><span class="font-bold">D :</span> Votre système est cassé. C'est une urgence.</li>
                                    <li><span class="font-bold">F :</span> Votre système est inexistant. Vous avez du pain sur la planche.</li>
                                </ul>
                                <p class="text-sm mt-2"><span class="explanation-highlight">Note importante :</span> Si vous n'avez pas de système (pas d'upsell, pas d'emailing), la note sera F. C'est normal. Cela représente une opportunité, pas un échec.</p>
                            </div>
                        </div>
                    </div>
                    <!-- Final Summary (TICKET I: Replaced this block) -->
                    <div id="shopify-potential-box" class="mb-8">
                      <div class="p-4 bg-gradient-to-r from-primary to-secondary rounded-lg text-white">
                        <p class="text-lg mb-2">Revenus Potentiels Totaux :</p>
                        <p id="shopify-total-pot-rev" class="text-3xl font-bold mb-2">0 FCFA</p>
                        <div id="shopify-potential-breakdown" class="mt-3 p-3 bg-yellow-50 text-yellow-900 rounded-lg dark:bg-yellow-900/10 dark:text-yellow-300" style="display:none;">
                            <div id="potentials-breakdown-host"></div>
                        </div>
                      </div>
                    </div>
                    <!-- TICKET B: Explication Revenus Potentiels Totaux -->
                    <div id="final-summary-explanation" class="mt-4">
                      <div class="analysis-question collapsible-title" onclick="toggleCollapsible(this)">
                        D'où vient le chiffre "Revenus Potentiels Totaux" ?
                        <svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                      </div>
                      <div class="analysis-answer detailed-explanation-content" style="display:none;">
                        <p class="text-sm">
                          D'où vient le chiffre "Revenus Potentiels Totaux" ? Ce n'est pas de la magie — c'est la somme des éléments suivants :
                        </p>
                        <ul class="list-disc pl-5 text-sm mt-2">
                          <li>Votre CA actuel (ventes directes)</li>
                          <li>+ Cash additionnel des upsells</li>
                          <li>+ Revenus attendus via Email & WhatsApp (flows + campagnes)</li>
                          <li>+ Cash récupéré des commandes annulées (estimation)</li>
                        </ul>
                        <p class="text-sm mt-2">Conclusion : ce chiffre représente ce que votre business **pourrait** produire si vous mettez en place les systèmes indiqués.</p>
                      </div>
                    </div>
                    <!-- CTA -->
                    <!-- CHANGED: copy replaced per copywriting PDF (2025-08) — Final CTA section -->
                    <div class="text-center py-6">
                        <!-- TICKET E: Texte avant CTA -->
                        <p class="mt-4 text-lg mb-4 dark:text-gray-300">
                          Pour économiser des mois d'essais et d'erreurs qui vous feront perdre encore plus d'argent, <br>découvrez comment récupérer ce chiffre d'affaire avec nous. <br>Nous discuterons de la situation actuelle de votre boutique et de vos objectifs pour trouver les solutions adaptées à votre situation.
                        </p>
                        <!-- TICKET 4: Updated href for main CTA button -->
                        <a href="https://calendly.com/tekanbidossessi/30min" target="_blank" class="px-8 py-4 bg-accent text-white font-bold text-lg rounded-lg shadow hover:bg-purple-700 transition-colors inline-block dark:bg-purple-600 dark:hover:bg-purple-700">
                            DEBLOQUER LES REVENUS DE MON SYSTEME
                        </a>

                        <!-- TICKET 6: Share buttons -->
                        <div id="share-controls" class="mt-4 flex gap-2 justify-center">
                          <button id="btn-share-native" class="px-3 py-2 rounded bg-indigo-600 text-white">Partager</button>
                          <button id="btn-share-wa" class="px-3 py-2 rounded bg-green-500 text-white">WhatsApp (avec résultats)</button>
                          <button id="btn-copy-link" class="px-3 py-2 rounded bg-gray-200 text-gray-800">Copier le lien</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- FAQ Section -->
        <!-- CHANGED: copy replaced per copywriting PDF (2025-08) — Entire FAQ Section -->
        <div class="max-w-4xl mx-auto px-4 py-12">
            <h2 class="text-3xl font-bold font-heading text-center mb-8 text-primary dark:text-blue-400">Questions Fréquemment Posées (FAQ)</h2>
            <div class="space-y-4">
                <div>
                    <div class="faq-question collapsible-title" onclick="toggleCollapsible(this)">
                        <span>C'est quoi un "bon" CPA ou un "bon" ROAS ?</span>
                        <svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </div>
                    <div class="faq-answer">
                        <p>Ça dépend de votre marge. Un ROAS de 3x peut être excellent pour une entreprise avec 80% de marge, et désastreux pour une autre avec 30%. La vraie question n'est pas "mon ROAS est-il bon?", mais "comment puis-je augmenter la valeur de chaque client pour que mon ROAS n'ait presque plus d'importance ?". C'est le but d'un système de vente organique.</p>
                    </div>
                </div>
                <div>
                    <div class="faq-question collapsible-title" onclick="toggleCollapsible(this)">
                        <span>Pourquoi ma marge est si faible alors que je vends beaucoup ?</span>
                        <svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </div>
                    <div class="faq-answer">
                        <p>Parce que vous êtes dépendant d'un seul pilier : l'acquisition payante. Les coûts pub augmentent, vos coûts de livraison sont élevés, et chaque client n'achète qu'une seule fois. Non seulement ça, des lacunes dans vos campagnes font exploser votre CPA. Sans système pour faire revenir les clients et augmenter le panier moyen, votre marge sera toujours sous pression.</p>
                    </div>
                </div>
                <div>
                    <div class="faq-question collapsible-title" onclick="toggleCollapsible(this)">
                        <span>Les upsells, ça ne dérange pas les clients ?</span>
                        <svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </div>
                    <div class="faq-answer">
                        <p>Des mauvais upsells dérangent les clients. Des bons upsells leur rendent service. Dans un resto, on vous demande "Voulez-vous des boissons avec ça ?" parce que ça améliore le repas. Un bon upsell est une offre logique qui complète l'achat initial et apporte plus de valeur au client.</p>
                    </div>
                </div>
                <div>
                    <div class="faq-question collapsible-title" onclick="toggleCollapsible(this)">
                        <span>Le marketing par Email/WhatsApp, n'est-ce pas du spam ?</span>
                        <svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </div>
                    <div class="faq-answer">
                        <p>Envoyer des promotions sans valeur est du spam. Envoyer du contenu utile, des conseils, et des offres pertinentes à une liste de personnes qui ont accepté de vous écouter est la base d'un business durable. C'est la différence entre interrompre et engager.</p>
                    </div>
                </div>
                <div>
                    <div class="faq-question collapsible-title" onclick="toggleCollapsible(this)">
                        <span>Pourquoi je n'arrive pas à dépasser le plafond des 10M FCFA ?</span>
                        <svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </div>
                    <div class="faq-answer">
                        <p>Parce que les stratégies qui vous ont amené à 2-5M ne sont pas celles qui vous amèneront à 10M et au-delà. Vous avez atteint la limite de ce que "se débrouiller" peut accomplir. Pour passer au niveau supérieur, vous avez besoin d'un <strong>système de vente organique prévisible</strong> : un système d'acquisition qui ne dépend pas à 100% de la pub, un système de conversion qui maximise chaque clic, et un système de rétention qui transforme les clients en fans.</p>
                    </div>
                </div>
                <div>
                    <div class="faq-question collapsible-title" onclick="toggleCollapsible(this)">
                        <span>Qu'est-ce que le "Système de vente organique" et pourquoi est-il crucial ?</span>
                        <svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </div>
                    <div class="faq-answer">
                        <p>Le "Système de vente organique" est un ensemble de stratégies et de canaux (contenu marketing, tunnels de vente optimisés, marketing par Email & WhatsApp) qui vous permettent de :</p>
                        <ul class="list-disc pl-5 mt-2 space-y-1">
                            <li><strong>Construire la Confiance :</strong> En diffusant du contenu de valeur avant l'achat, vous éduquez votre audience, répondez à leurs objections et devenez une marque fiable.</li>
                            <li><strong>Fidéliser les Clients :</strong> En continuant la communication après l'achat, vous transformez des acheteurs uniques en clients récurrents et ambassadeurs.</li>
                            <li><strong>Maximiser la Valeur Client (LTV) :</strong> Grâce à l'upselling, le cross-selling et la fidélisation, vous augmentez le chiffre d'affaires généré par chaque client.</li>
                        </ul>
                         <p class="mt-2">Ce système est crucial car il réduit votre dépendance à la publicité payante coûteuse, améliore vos taux de conversion et augmente vos marges, vous permettant de franchir durablement le cap des 10 millions FCFA mensuels.</p>
                    </div>
                </div>
                <div>
                    <!-- TICKET J: Replaced FAQ answer content and added CTA -->
                    <div class="faq-question collapsible-title" onclick="toggleCollapsible(this)">
                        <span>Comment fonctionne votre agence et votre approche ?</span>
                        <svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    </div>
                    <div class="faq-answer detailed-explanation-content">
                      <p class="text-sm mb-4">7 e-commerçants sur 10 en Afrique de l'Ouest sont bloqués par l'imprévisibilité et le stress.<br><br>
                      Ils utilisent des tactiques isolées au lieu de créer un <strong>système de vente organique</strong>.<br><br>
                      Chez Momentum Média, nous avons créé notre système en 5 piliers : <strong>Branding, Offre, Contenu, Funnel et Rétention</strong>. Ce système est né de nos échecs pour mieux répondre à VOS réalités.<br><br>
                      Au lieu de gérer le chaos quotidien, trouvez un partenaire qui crée votre machine de vente. Cela vous permettra de respirer enfin. Vous aurez donc : une croissance stable et la tranquillité d'esprit d'un PDG qui a repris le contrôle.</p>

                      <p class="text-sm mb-4">Si vous êtes un e-commerçant qui fait plus de <strong>5 000 000 FCFA mensuellement</strong>, nous vous proposons :</p>
                      <ol class="list-decimal pl-5 text-sm space-y-2 mb-4">
                        <li>Planifiez un Audit.</li>
                        <li>Recevez un Diagnostic et une Feuille de Route Personnalisée.</li>
                        <li>Décidez si notre Partenariat est la bonne prochaine étape.</li>
                      </ol>

                      <div class="text-center mt-4">
                        <!-- TICKET 3: Changed CTA text in the last FAQ answer -->
                        <a href="https://calendly.com/tekanbidossessi/30min" target="_blank" rel="noopener" class="px-5 py-3 bg-primary text-white rounded-md inline-block">DEBLOQUER LES REVENUS DE MON SYSTEME</a>
                        <p class="text-xs italic mt-2">c'est gratuit et sans engagement</p>
                      </div>
                    </div>
                </div>
                <!-- TICKET 3: Removed the "Est-ce que cet outil est précis ?" FAQ item -->
            </div>
            <!-- TICKET A: DONNEZ-NOUS VOS SUGGESTIONS - centré, ouvre MailerLite (popup ID mXMWdM) avec fallback preview -->
            <div class="mt-6 text-center">
              <!-- TICKET G: MailerLite button link -->
              <button class="px-5 py-3 bg-primary text-white rounded-md inline-flex items-center gap-2" aria-expanded="false" onclick="window.open('https://preview.mailerlite.io/forms/1274079/164160964725311195/share','_blank')">
                Donnez-nous vos suggestions
                <!-- small chevron for button -->
                <svg class="w-4 h-4" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 8l4 4 4-4" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
            </div>
        </div>
    </div>
    <script>
        // Generic Toggle Function for Collapsible Elements (TICKET F: Updated)
        function toggleCollapsible(el) {
          try {
            // Accept either the title element or an inner element
            let title = el;
            if (!title.classList.contains('collapsible-title')) {
              // try to find parent
              title = el.closest('.collapsible-title') || el;
            }
            const content = title.nextElementSibling;
            const isOpen = content && content.style.display === 'block';
            if (isOpen) {
              content.style.display = 'none';
              title.classList.remove('open');
              title.setAttribute('aria-expanded','false');
            } else if (content) {
              content.style.display = 'block';
              title.classList.add('open');
              title.setAttribute('aria-expanded','true');
            }
          } catch(e){ console.warn('toggleCollapsible', e); }
        }

        // Dark Mode Toggle
        function toggleDarkMode() {
            const htmlElement = document.documentElement;
            htmlElement.classList.toggle('dark');

            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');

            if (htmlElement.classList.contains('dark')) {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
            localStorage.setItem('theme', htmlElement.classList.contains('dark') ? 'dark' : 'light');
        }

        // Check for saved theme preference or respect OS preference
        function initDarkMode() {
            const htmlElement = document.documentElement;
            const savedTheme = localStorage.getItem('theme');
            const osPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme === 'dark' || (!savedTheme && osPrefersDark)) {
                htmlElement.classList.add('dark');
                document.getElementById('sun-icon').classList.add('hidden');
                document.getElementById('moon-icon').classList.remove('hidden');
            } else {
                htmlElement.classList.remove('dark');
                document.getElementById('sun-icon').classList.remove('hidden');
                document.getElementById('moon-icon').classList.add('hidden');
            }
        }

        // Initialize dark mode on page load
        document.addEventListener('DOMContentLoaded', function() {
            initDarkMode();
            // Wire the toggle button click event
            document.getElementById('dark-mode-toggle').addEventListener('click', toggleDarkMode);
        });

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn').forEach(tab => {
                tab.classList.remove('tab-active');
            });
            // Show selected tab content
            document.getElementById(`${tabName}-tab-content`).classList.remove('hidden');
            // Add active class to selected tab
            document.getElementById(`${tabName}-tab`).classList.add('tab-active');

            // TICKET 11: Scroll to top of Shopify tab when switching from meta CTA
            if (tabName === 'shopify') {
                const container = document.getElementById('shopify-tab-content');
                if (container) container.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Tooltip interaction for touch devices
        document.addEventListener('DOMContentLoaded', function() {
            const tooltips = document.querySelectorAll('.info-tooltip');
            tooltips.forEach(tooltip => {
                tooltip.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent event bubbling
                    // For touch devices, toggle active class
                    if (window.matchMedia('(hover: none) and (pointer: coarse)').matches) {
                        this.classList.toggle('active');
                    }
                });
            });

            // Close tooltips when clicking elsewhere
            document.addEventListener('click', function() {
                tooltips.forEach(tooltip => {
                    tooltip.classList.remove('active');
                });
            });
        });

        // Toggle conversion fields based on selection in Meta Ads Tab
        function toggleConversionFields() {
            const conversionType = document.getElementById('meta-conversion-type').value;

            // Hide all conversion-specific sections first
            document.getElementById('whatsapp-fields').classList.add('hidden');
            document.getElementById('shopify-fields').classList.add('hidden');
            document.getElementById('whatsapp-upsells-question').classList.add('hidden');
            document.getElementById('whatsapp-upsell-dropdown').classList.add('hidden');
            document.getElementById('whatsapp-upsell-price-input').classList.add('hidden'); // TICKET C
            document.getElementById('shopify-upsells-question-meta').classList.add('hidden');
            document.getElementById('shopify-upsell-dropdown-meta').classList.add('hidden');
            document.getElementById('shopify-upsell-price-input-meta').classList.add('hidden'); // TICKET C
            // TICKET 6: Keep Email/WhatsApp UI hidden in Acquisition tab always (No change here, handled by DOMContentLoaded)

            // Show relevant sections based on selection
            if (conversionType === 'whatsapp') {
                document.getElementById('whatsapp-fields').classList.remove('hidden');
                document.getElementById('whatsapp-upsells-question').classList.remove('hidden');
            } else if (conversionType === 'shopify') {
                document.getElementById('shopify-fields').classList.remove('hidden');
                document.getElementById('shopify-upsells-question-meta').classList.remove('hidden');
            }
        }
        // Toggle upsell dropdown for WhatsApp in Meta Ads Tab (TICKET C)
        function toggleWhatsappUpsellDropdown() {
          const hasUpsells = document.getElementById('whatsapp-has-upsells').checked;
          const dd = document.getElementById('whatsapp-upsell-dropdown');
          const price = document.getElementById('whatsapp-upsell-price-input');
          if (hasUpsells) {
            if (dd) dd.classList.remove('hidden');
            if (price) price.classList.remove('hidden');
          } else {
            if (dd) dd.classList.add('hidden');
            if (price) price.classList.add('hidden');
          }
        }
        // Toggle upsell dropdown for Shopify in Meta Ads Tab (TICKET C)
        function toggleShopifyUpsellDropdownMeta() {
          const hasUpsells = document.getElementById('shopify-has-upsells-meta').checked;
          const dd = document.getElementById('shopify-upsell-dropdown-meta');
          const price = document.getElementById('shopify-upsell-price-input-meta');
          if (hasUpsells) {
            if (dd) dd.classList.remove('hidden');
            if (price) price.classList.remove('hidden');
          } else {
            if (dd) dd.classList.add('hidden');
            if (price) price.classList.add('hidden');
          }
        }
        // Toggle upsell dropdown and price input for Shopify Tab
        function toggleShopifyUpsellDropdown() {
            const hasUpsells = document.getElementById('shopify-has-upsells').checked;
            if (hasUpsells) {
                document.getElementById('shopify-upsell-dropdown').classList.remove('hidden');
                document.getElementById('shopify-upsell-price-input').classList.remove('hidden');
            } else {
                document.getElementById('shopify-upsell-dropdown').classList.add('hidden');
                document.getElementById('shopify-upsell-price-input').classList.add('hidden');
            }
        }
         // Toggle Email/WhatsApp dropdown for Meta Ads Tab
        function toggleMetaEmailWhatsAppDropdown() {
            const hasEmailWhatsapp = document.getElementById('meta-has-email-whatsapp').checked;
            if (hasEmailWhatsapp) {
                document.getElementById('meta-email-whatsapp-dropdown').classList.remove('hidden');
            } else {
                document.getElementById('meta-email-whatsapp-dropdown').classList.add('hidden');
            }
        }
         // Toggle Email/WhatsApp dropdown for Shopify Tab
        function toggleShopifyEmailWhatsAppDropdown() {
            const hasEmailWhatsapp = document.getElementById('shopify-has-email-whatsapp').checked;
            if (hasEmailWhatsapp) {
                document.getElementById('shopify-email-whatsapp-dropdown').classList.remove('hidden');
            } else {
                document.getElementById('shopify-email-whatsapp-dropdown').classList.add('hidden');
            }
        }

        // MINIMAL SAFE HELPERS (already applied in previous step)
        function safeNumber(x, fallback = 0) {
          const n = Number(x);
          return (isFinite(n) && !isNaN(n)) ? n : fallback;
        }
        function safeDivide(a, b, fallback = 0) {
          a = safeNumber(a);
          b = safeNumber(b);
          if (b === 0) return fallback;
          return a / b;
        }
        // TICKET A: Round FCFA values to integers (no decimals)
        function formatFCFA(n) {
          // safeNumber existante est déjà définie ; on arrondit et on formatte FR
          return Math.round(safeNumber(n)).toLocaleString('fr-FR') + ' FCFA';
        }

        // TICKET C: Helper to parse percentages as fractions
        const parsePct = id => {
          const v = parseFloat((document.getElementById(id) || {}).value);
          return Number.isFinite(v) ? v / 100 : 0;
        };

        // ---------- TICKET 1: FX (USD -> XOF) fetch + cache ----------
        const DEFAULT_FX = 600; // fallback
        const FX_CACHE_KEY = 'fx_usd_xof';
        const FX_CACHE_TTL = 12 * 60 * 60 * 1000; // 12 hours

        window.FX_FCFA_PER_USD = DEFAULT_FX; // valeur globale par défaut

        async function fetchFxUsdToXof() {
          try {
            const cached = localStorage.getItem(FX_CACHE_KEY);
            if (cached) {
              const obj = JSON.parse(cached);
              if (Date.now() - obj.ts < FX_CACHE_TTL && obj.rate) {
                window.FX_FCFA_PER_USD = Number(obj.rate);
                return window.FX_FCFA_PER_USD;
              }
            }

            const resp = await fetch('https://api.exchangerate.host/latest?base=USD&symbols=XOF', {cache: 'no-cache'});
            if (!resp.ok) throw new Error('fx fetch failed ' + resp.status);
            const data = await resp.json();
            const rate = data && data.rates && data.rates.XOF ? Number(data.rates.XOF) : null;
            if (!rate || isNaN(rate)) throw new Error('invalid fx data');

            localStorage.setItem(FX_CACHE_KEY, JSON.stringify({rate, ts: Date.now()}));
            window.FX_FCFA_PER_USD = rate;
            return rate;
          } catch (err) {
            console.warn('fetchFxUsdToXof failed, using fallback. err:', err);
            // try to use stale cache if present
            try {
              const cached = JSON.parse(localStorage.getItem(FX_CACHE_KEY) || '{}');
              if (cached && cached.rate) {
                window.FX_FCFA_PER_USD = Number(cached.rate);
                return window.FX_FCFA_PER_USD;
              }
            } catch(e){/* ignore */ }
            window.FX_FCFA_PER_USD = DEFAULT_FX;
            return DEFAULT_FX;
          }
        }

        // ---------- TICKET 4: Share payload utilities ----------
        function base64UrlEncode(str) {
          return btoa(unescape(encodeURIComponent(str))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
        }
        function base64UrlDecode(b64) {
          b64 = b64.replace(/-/g,'+').replace(/_/g,'/');
          while (b64.length % 4) b64 += '=';
          return decodeURIComponent(escape(atob(b64)));
        }

        function generateSharePayload(resultsObj) {
          const json = JSON.stringify(resultsObj);
          const encoded = base64UrlEncode(json);
          const base = window.location.origin + window.location.pathname;
          return `${base}?share=${encoded}`;
        }

        // ---------- TICKET 5: Web Share + fallbacks ----------
        async function openNativeShare(resultsObj) {
          const shareUrl = generateSharePayload(resultsObj);
          const shareText = `J'ai utilisé le Scanner de Profit E-com — regarde mes résultats : ${shareUrl}`;

          if (navigator.share) {
            try {
              await navigator.share({ title: 'Mes résultats - Scanner de Profit E-com', text: shareText, url: shareUrl });
              return true;
            } catch (e) {
              console.warn('navigator.share failed', e);
            }
          }

          // Fallback: ask user to choose WhatsApp, Telegram or copy
          const choice = confirm('Partage non natif — ouvrir WhatsApp ? (OK = WhatsApp / Annuler = Copier lien)');
          if (choice) {
            const waUrl = 'https://wa.me/?text=' + encodeURIComponent(shareText);
            window.open(waUrl, '_blank');
          } else {
            try { await navigator.clipboard.writeText(shareUrl); alert('Lien copié.'); }
            catch (e) { prompt('Copiez ce lien:', shareUrl); }
          }
        }


        // Calculate Meta Ads Results
        function calculateMetaResults() {
             // Get input values
            const adSpendUSD = parseFloat(document.getElementById('meta-ad-spend').value) || 0;
            const impressions = parseFloat(document.getElementById('meta-impressions').value) || 0;
            const clicks = parseFloat(document.getElementById('meta-clicks').value) || 0;
            // Removed CPA USD input (TICKET 5)
            const conversionType = document.getElementById('meta-conversion-type').value;

            // Conversion-specific values
            let conversions = 0;
            let productPriceFCFA = 0;
            let hasUpsells = false;

            if (conversionType === 'whatsapp') {
                conversions = parseFloat(document.getElementById('whatsapp-conversions').value) || 0;
                productPriceFCFA = parseFloat(document.getElementById('whatsapp-product-price').value) || 0;
                hasUpsells = document.getElementById('whatsapp-has-upsells').checked;
            } else if (conversionType === 'shopify') {
                conversions = parseFloat(document.getElementById('shopify-orders').value) || 0;
                productPriceFCFA = parseFloat(document.getElementById('shopify-product-price-meta').value) || 0;
                hasUpsells = document.getElementById('shopify-has-upsells-meta').checked;
            }
            // Assume exchange rate for calculations (1 USD = 600 FCFA)
            const exchangeRate = window.FX_FCFA_PER_USD; // TICKET 1: Using global FX rate

            // Calculate metrics
            const ctr = safeDivide(clicks, impressions) * 100;
            const conversionRate = safeDivide(conversions, clicks) * 100;
            let totalRevenueFCFA = conversions * productPriceFCFA; // Base revenue

            // TICKET 7: Calculate upsell revenue and add to total revenue
            let upsellRevenueFCFA = 0;
            try {
              const currentUpsellCheckbox = conversionType === 'whatsapp' ? document.getElementById('whatsapp-has-upsells') : document.getElementById('shopify-has-upsells-meta');
              const currentUpsellPercentageSelect = conversionType === 'whatsapp' ? document.getElementById('whatsapp-upsell-percentage') : document.getElementById('shopify-upsell-percentage-meta');

              if (currentUpsellCheckbox && currentUpsellCheckbox.checked) {
                const upsPct = parseFloat(currentUpsellPercentageSelect?.value || 0);
                const conversionsForUpsell = conversions;

                // TICKET C: Read value from new input, with fallback
                let avgUpsellPriceFCFA = productPriceFCFA * 0.5; // fallback
                try {
                  const avgId = (conversionType === 'whatsapp') ? 'whatsapp-upsell-average-price' : 'shopify-upsell-average-price-meta';
                  const v = parseFloat(document.getElementById(avgId)?.value);
                  if (!isNaN(v) && v > 0) avgUpsellPriceFCFA = v;
                } catch(e) { /* fallback already set */ }

                upsellRevenueFCFA = Math.round(conversionsForUpsell * upsPct * avgUpsellPriceFCFA);
              }
            } catch(e){ upsellRevenueFCFA = 0; console.warn('Meta upsell calc failed', e); }

            const totalRevenueWithUpsells = totalRevenueFCFA + upsellRevenueFCFA;
            const adSpendFCFA = adSpendUSD * exchangeRate;
            const roas = safeDivide(totalRevenueWithUpsells, adSpendFCFA); // Use totalRevenueWithUpsells for ROAS

            // TICKET 8: CPA calculation (adSpend / conversions)
            const cpaUSDCalc = safeDivide(adSpendUSD, conversions);

            // CHANGED: copy replaced per copywriting PDF (2025-08) — Marge Brute Calculation (now not displayed as metric)
            const netProfitExcludingFulfillment = totalRevenueWithUpsells - adSpendFCFA;
            const margeBruteSansFulfillment = safeDivide(netProfitExcludingFulfillment, totalRevenueWithUpsells) * 100;

            // Format numbers
            const formatPercent = (value) => safeNumber(value).toFixed(1) + '%';

            // Display results
            document.getElementById('meta-total-revenue').textContent = formatFCFA(totalRevenueWithUpsells);
            document.getElementById('meta-ctr').textContent = formatPercent(ctr);
            document.getElementById('meta-conv-rate').textContent = formatPercent(conversionRate);
            document.getElementById('meta-roas').textContent = safeNumber(roas).toFixed(2) + 'x';
            // document.getElementById('meta-margin').textContent = formatPercent(margeBruteSansFulfillment); // Replaced by CPA
            document.getElementById('meta-cpa-display').textContent = safeNumber(cpaUSDCalc).toFixed(2) + ' USD'; // Display CPA (TICKET 8)


            // TICKET 9: Analysis Blocks for Acquisition Tab
            let analysisHTML = '';
            // CTR Analysis
            if (ctr < 1) {
                analysisHTML += `<div class="p-4 bg-red-50 rounded-lg dark:bg-red-900/20"><h4 class="font-bold text-red-700 dark:text-red-400 collapsible-title" onclick="toggleCollapsible(this)"><span>Diagnostic : Vos Pubs sont Ignorées.</span><svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></h4><div class="collapsible-content">
                    <p><strong>Le Diagnostic Brut :</strong> Votre Taux de Clics (CTR) est de ${formatPercent(ctr)}. Pour 1000 personnes qui voient votre publicité, moins de 10 s'arrêtent pour cliquer.</p>
                    <p class="mt-2"><strong>Cela signifie que</strong> votre message est noyé dans le tas. Vous payez pour être invisible.</p>
                    <p class="mt-2"><strong>Causes Probables :</strong> Votre visuel ne capte pas l'attention, votre phrase d'accroche est faible, ou vous ciblez les mauvaises personnes (avatar cible non adapté au produit et au marché).</p>
                    <p class="mt-2"><strong>L'Impact Financier :</strong> C'est la première fuite de votre budget. Chaque dollar dépensé pour des impressions non cliquées est un dollar brûlé avant même que la course ne commence.</p>
                </div></div>`;
            } else if (ctr <= 2.5) {
                analysisHTML += `<div class="p-4 bg-yellow-50 rounded-lg dark:bg-yellow-900/20"><h4 class="font-bold text-yellow-700 dark:text-yellow-400 collapsible-title" onclick="toggleCollapsible(this)"><span>Point à Améliorer : Votre CTR est Correct, Pas Excellent.</span><svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></h4><div class="collapsible-content">
                    <p><strong>Le Diagnostic Brut :</strong> Votre CTR de ${formatPercent(ctr)} est dans la moyenne du marché. C'est un début.</p>
                    <p class="mt-2"><strong>Cela signifie que</strong> vous captez un certain intérêt, mais vous n'êtes pas encore mémorable. "Moyen" est le terrain de jeu le plus compétitif et le moins profitable.</p>
                    <p class="mt-2"><strong>Causes Probables :</strong> Votre offre est intéressante mais pas irrésistible, ou votre message manque de clarté et d'un angle unique. Votre branding ne s'alligne peut-être pas avec le message de votre créative.</p>
                    <p class="mt-2"><strong>L'Impact Financier :</strong> Vous laissez des clients potentiels et moins chers sur la table. Augmenter votre CTR de 0.5% peut réduire votre coût d'acquisition de 20-30% et potentiellement doublé votre revenue.</p>
                </div></div>`;
            } else {
                analysisHTML += `<div class="p-4 bg-green-50 rounded-lg dark:bg-green-900/20"><h4 class="font-bold text-green-700 dark:text-green-400 collapsible-title" onclick="toggleCollapsible(this)"><span>Force: Vos Pubs Attirent le Clic.</span><svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></h4><div class="collapsible-content">
                    <p><strong>Le Diagnostic Brut :</strong> Un CTR de ${formatPercent(ctr)} est excellent. Vous savez capter l'attention de votre marché.</p>
                    <p class="mt-2"><strong>Cela signifie que</strong> le premier maillon de votre système d'acquisition est solide. Le trafic que you générez est qualifié et intéressé.</p>
                    <p class="mt-2"><strong>La Prochaine Étape :</strong> L'attention est acquise. La question critique est maintenant : que faites-vous de ce trafic une fois qu'il arrive sur votre site ? C'est là que se situe la prochaine fuite potentielle.</p>
                </div></div>`;
            }
            // Conversion Rate Analysis
            if (conversionRate < 3) {
                analysisHTML += `<div class="p-4 bg-red-50 rounded-lg dark:bg-red-900/20 mt-4"><h4 class="font-bold text-red-700 dark:text-red-400 collapsible-title" onclick="toggleCollapsible(this)"><span>Diagnostic : Votre Site est une Passoire à Trafic.</span><svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></h4><div class="collapsible-content">
                    <p><strong>Le Diagnostic Brut :</strong> Votre Taux de Conversion est de ${formatPercent(conversionRate)}. Sur 100 visiteurs que vous avez payés cher pour amener sur votre site, ${100 - parseFloat(conversionRate.toFixed(0))} (ou plus) repartent sans acheter.</p>
                    <p class="mt-2"><strong>Cela signifie que</strong> vous avez réussi à les faire entrer dans le magasin, mais votre offre ou votre expérience d'achat les fait fuir.</p>
                    <p class="mt-2"><strong>Causes Probables :</strong> Votre offre est faible, votre site manque de confiance (preuves sociales, design pro, branding inspirant la confiance), ou le formulaire de commande est une source de friction (compliqué ou ne fonctionne pas correctement).</p>
                    <p class="mt-2"><strong>L'Impact Financier :</strong> Votre coût d'acquisition effectif est astronomique. Vous payez pour du trafic qui ne rapporte rien. C'est le chemin le plus rapide vers un business non rentable.</p>
                </div></div>`;
            } else if (conversionRate <= 5) {
                analysisHTML += `<div class="p-4 bg-yellow-50 rounded-lg dark:bg-yellow-900/20 mt-4"><h4 class="font-bold text-yellow-700 dark:text-yellow-400 collapsible-title" onclick="toggleCollapsible(this)"><span>Point à Améliorer : Vous Laissez la Moitié de Vos Ventes Potentielles s'Échapper.</span><svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></h4><div class="collapsible-content">
                    <p><strong>Le Diagnostic Brut :</strong> Votre taux de conversion de ${formatPercent(conversionRate)} est correct, mais loin d'être optimisé.</p>
                    <p class="mt-2"><strong>Cela signifie que</strong> votre système fonctionne, mais il a des fuites majeures. Pour chaque client que vous obtenez, vous en perdez un autre qui était pourtant intéressé.</p>
                    <p class="mt-2"><strong>Causes Probables :</strong> Manque d'urgence, garanties faibles, ou pas assez de raisons de croire en votre produit par rapport à la concurrence.</p>
                    <p class="mt-2"><strong>L'Impact Financier :</strong> Doubler ce chiffre est possible avec les bons systèmes d'optimisation de la conversion (CRO), ce qui diviserait par deux votre coût par acquisition sans dépenser un dollar de plus en pub.</p>
                </div></div>`;
            } else {
                analysisHTML += `<div class="p-4 bg-green-50 rounded-lg dark:bg-green-900/20 mt-4"><h4 class="font-bold text-green-700 dark:text-green-400 collapsible-title" onclick="toggleCollapsible(this)"><span>Force: Votre Site est une Machine à Convertir.</span><svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></h4><div class="collapsible-content">
                    <p><strong>Le Diagnostic Brut :</strong> Un taux de conversion de ${formatPercent(conversionRate)} est excellent. Votre branding, votre offre et votre tunnel de vente sont alignés et efficaces.</p>
                    <p class="mt-2"><strong>Cela signifie que</strong> vous avez un système fiable pour transformer les clics en clients. C'est l'un des actifs les plus précieux de votre business.</p>
                    <p class="mt-2"><strong>La Prochaine Étape :</strong> La conversion est maîtrisée. Le prochain levier de croissance exponentielle est d'augmenter la valeur de chaque conversion c'est-à-dire pousser un client à acheter plus et à revenir plusieurs fois.</p>
                </div></div>`;
            }
            // ROAS Analysis
            if (roas < 3) {
                analysisHTML += `<div class="p-4 bg-red-50 rounded-lg dark:bg-red-900/20 mt-4"><h4 class="font-bold text-red-700 dark:text-red-400 collapsible-title" onclick="toggleCollapsible(this)"><span>Diagnostic: Vous Payez pour Acquérir des Clients à Perte.</span><svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></h4><div class="collapsible-content">
                    <p><strong>Le Diagnostic Brut :</strong> Votre ROAS est de ${safeNumber(roas).toFixed(2)}x. Pour chaque 1000 FCFA dépensés en pub, vous générez moins de 3000 FCFA de CA, ce qui est presque certainement une perte nette après le coût du produit.</p>
                    <p class="mt-2"><strong>Cela signifie que</strong> votre modèle d'acquisition actuel n'est pas viable. Plus vous dépensez, plus vous perdez.</p>
                    <p class="mt-2"><strong>Causes Probables :</strong> Un CPA trop élevé, un prix de vente trop bas, ou l'absence totale de système pour augmenter le panier moyen (upsells).</p>
                    <p class="mt-2"><strong>L'Impact Financier :</strong> Vous êtes sur un tapis roulant vers l'épuisement de votre trésorerie. Ce n'est pas un problème de scaling, c'est un problème de survie.</p>
                </div></div>`;
            } else if (roas <= 5) {
                analysisHTML += `<div class="p-4 bg-yellow-50 rounded-lg dark:bg-yellow-900/20 mt-4"><h4 class="font-bold text-yellow-700 dark:text-yellow-400 collapsible-title" onclick="toggleCollapsible(this)"><span>Point à Améliorer : Votre Rentabilité est Fragile.</span><svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></h4><div class="collapsible-content">
                    <p><strong>Le Diagnostic Brut :</strong> Votre ROAS de ${safeNumber(roas).toFixed(2)}x vous permet de rester à flot, mais sans plus.</p>
                    <p class="mt-2"><strong>Cela signifie que</strong> vous êtes rentable, mais vous n'avez pas de marge de sécurité. Une simple augmentation du coût des publicités par Meta peut rendre tout votre système non rentable du jour au lendemain.</p>
                    <p class="mt-2"><strong>Causes Probables :</strong> Vous dépendez uniquement de la première vente. Vous n'avez pas de système en backend pour maximiser la Valeur Vie Client (LTV).</p>
                    <p class="mt-2"><strong>L'Impact Financier :</strong> Vous ne pouvez pas vous permettre de scaler agressivement. Votre croissance est plafonnée par la peur de voir votre rentabilité disparaître.</p>
                </div></div>`;
            } else {
                analysisHTML += `<div class="p-4 bg-green-50 rounded-lg dark:bg-green-900/20 mt-4"><h4 class="font-bold text-green-700 dark:text-green-400 collapsible-title" onclick="toggleCollapsible(this)"><span>Force: Votre Machine d'Acquisition est Rentable.</span><svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></h4><div class="collapsible-content">
                    <p><strong>Le Diagnostic Brut :</strong> Un ROAS de ${safeNumber(roas).toFixed(2)}x est solide. Chaque franc investi en publicité génère un retour significatif.</p>
                    <p class="mt-2"><strong>Cela signifie que</strong> vous avez un modèle d'acquisition qui fonctionne et qui finance sa propre croissance.</p>
                    <p class="mt-2"><strong>La Prochaine Étape :</strong> Ce chiffre est le plancher de votre rentabilité. Avec des systèmes de maximisation (Funnel Max) et de rétention (Email/WhatsApp), ce ROAS de front-end pourrait devenir la porte d'entrée vers une profitabilité beaucoup plus grande.</p>
                </div></div>`;
            }
            document.getElementById('meta-analysis').innerHTML = analysisHTML;

            // TICKET 10: Benchmark comparison (Changed label)
            let benchmarkHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="p-4 border border-gray-200 rounded-lg dark:border-gray-700"><p class="font-medium">Votre CTR : ${formatPercent(ctr)}</p><p class="text-gray-600 dark:text-gray-400">Valeur de Référence : 1-2.5%</p><p class="${ctr < 1 ? 'text-red-600 dark:text-red-400' : ctr <= 2.5 ? 'text-yellow-600 dark:text-yellow-400' : 'text-green-600 dark:text-green-400'}">${ctr < 1 ? 'En dessous de la moyenne' : ctr <= 2.5 ? 'Moyen' : 'Au dessus de la moyenne'}</p></div><div class="p-4 border border-gray-200 rounded-lg dark:border-gray-700"><p class="font-medium">Votre Taux de Conversion : ${formatPercent(conversionRate)}</p><p class="text-gray-600 dark:text-gray-400">Valeur de Référence : 3-5%</p><p class="${conversionRate < 3 ? 'text-red-600 dark:text-red-400' : conversionRate <= 5 ? 'text-yellow-600 dark:text-yellow-400' : 'text-green-600 dark:text-green-400'}">${conversionRate < 3 ? 'En dessous de la moyenne' : conversionRate <= 5 ? 'Moyen' : 'Au dessus de la moyenne'}</p></div></div>`;
            document.getElementById('benchmark-comparison').innerHTML = benchmarkHTML;

            // Recommendations
            let recommendationsHTML = '';
            if (ctr < 1) {
                recommendationsHTML += `<div class="p-4 bg-blue-50 rounded-lg dark:bg-blue-900/20"><h4 class="font-bold text-blue-800 dark:text-blue-300 collapsible-title" onclick="toggleCollapsible(this)"><span>Action Prioritaire : Améliorez votre Créa Publicitaire</span><svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></h4><div class="collapsible-content"><p>Testez différentes images, titres et textes pour voir ce qui résonne avec votre audience. Utilisez des visuels de haute qualité et des accroches fortes ("anti-scroll"). Affinez votre ciblage. Un message trop large ou dilué peut nuire à la performance.</p></div></div>`;
            }
            if (conversionRate < 2) {
                recommendationsHTML += `<div class="p-4 bg-blue-50 rounded-lg dark:bg-blue-900/20"><h4 class="font-bold text-blue-800 dark:text-blue-300 collapsible-title" onclick="toggleCollapsible(this)"><span>Action Prioritaire : Optimisez votre Page de Destination</span><svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></h4><div class="collapsible-content"><p>Assurez-vous que votre page de destination est rapide, adaptée aux mobiles et communique clairement votre proposition de valeur. Simplifiez le processus d'achat. Vérifiez la cohérence entre votre message publicitaire et le contenu de la page. Un branding faible ou incohérent peut freiner la conversion.</p></div></div>`;
            }
            if (roas < 2) {
                recommendationsHTML += `<div class="p-4 bg-blue-50 rounded-lg dark:bg-blue-900/20"><h4 class="font-bold text-blue-800 dark:text-blue-300 collapsible-title" onclick="toggleCollapsible(this)"><span>Action Prioritaire : Affinez votre Ciblage et vos Créas</span><svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></h4><div class="collapsible-content"><p>Revoyez votre ciblage d'audience pour vous assurer que vous atteignez les personnes les plus susceptibles de convertir. Testez de nouveaux créas et messages. Un message publicitaire inefficace ou éloigné de l'expérience client peut augmenter le CPA et diminuer le ROAS.</p></div></div>`;
            }
            if (!hasUpsells) {
                recommendationsHTML += `<div class="p-4 bg-green-50 rounded-lg dark:bg-green-900/20"><h4 class="font-bold text-green-800 dark:text-green-300 collapsible-title" onclick="toggleCollapsible(this)"><span>Opportunité de Croissance : Ajoutez un Tunnel de Vente</span><svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></h4><div class="collapsible-content"><p>Implémentez des upsells, downsells et cross-sells pour augmenter la valeur moyenne de commande de 20 à 50%. Cela peut doubler ou tripler votre profit par client.</p></div></div>`;
            }
            document.getElementById('meta-recommendations').innerHTML = recommendationsHTML || "<p>Vos performances sont solides ! Continuez à tester et optimiser.</p>";

            // Show results
            document.getElementById('meta-results').classList.remove('hidden');

            // TICKET 12: Auto-fill Shopify tab with Meta data if conversion type is Shopify
            if (conversionType === 'shopify') {
                document.getElementById('shopify-ad-spend').value = safeNumber(document.getElementById('meta-ad-spend')?.value || 0);
                document.getElementById('shopify-orders-tab2').value = safeNumber(conversions || 0);
                document.getElementById('shopify-product-price-tab2').value = safeNumber(productPriceFCFA || 0);
                const metaImpressions = document.getElementById('meta-impressions')?.value;
                if (metaImpressions) document.getElementById('shopify-sessions').value = safeNumber(metaImpressions);
            }
        }

        // PATCH A: Submit-only validation for Shopify
        function validateOrdersOnSubmit_Shopify() {
          try {
            const ordersEl = document.getElementById('shopify-orders-tab2');
            const fulfilledEl = document.getElementById('shopify-fulfilled-orders');
            if (!ordersEl || !fulfilledEl) return true;

            const orders = parseInt(ordersEl.value || 0);
            const fulfilled = parseInt(fulfilledEl.value || 0);

            let banner = document.getElementById('shopify-error-banner');
            if (!banner) {
              banner = document.createElement('div');
              banner.id = 'shopify-error-banner';
              // minimal classes — style inline to avoid needing other CSS
              banner.style.display = 'none';
              banner.style.borderRadius = '8px';
              banner.style.padding = '10px';
              banner.style.marginBottom = '8px';
              banner.style.zIndex = '999'; // Ensure it's above other content
              const container = document.getElementById('shopify-results') || document.getElementById('shopify-tab-content') || document.getElementById('shopify-potential-box');
              // Insert before the container if available, otherwise just at the top of the body
              if (container && container.parentNode) {
                  container.parentNode.insertBefore(banner, container);
              } else {
                  document.body.insertBefore(banner, document.body.firstChild);
              }
            }

            // hide by default
            banner.style.display = 'none';
            banner.innerHTML = '';

            if (fulfilled > orders) {
              banner.style.display = 'block';
              banner.style.background = '#FFF4F4';
              banner.style.border = '1px solid #FCA5A5';
              banner.style.color = '#7F1D1D';
              banner.innerHTML = `
                <strong>Valeurs incohérentes</strong> — commandes livrées (${fulfilled}) > commandes totales (${orders}).<br>
                Merci de corriger ces champs avant de lancer le diagnostic.
                <div style="margin-top:8px;">
                  <button id="shopify-error-fix-btn" style="background:#F87171;color:white;border:none;padding:6px 10px;border-radius:6px;">Corriger</button>
                  <button id="shopify-error-ignore-btn" style="margin-left:8px;background:#E5E7EB;color:#111827;border:none;padding:6px 10px;border-radius:6px;">Je corrige plus tard</button>
                </div>
              `;
              document.getElementById('shopify-error-fix-btn').onclick = () => ordersEl.focus();
              document.getElementById('shopify-error-ignore-btn').onclick = () => { banner.style.display = 'none'; };
              return false;
            }
            return true;
          } catch (e) {
            console.warn('validateOrdersOnSubmit_Shopify', e);
            return true;
          }
        }


        // Calculate Shopify Results
        function calculateShopifyResults() {
            // PATCH A: Call validation at the start
            if (!validateOrdersOnSubmit_Shopify()) { switchTab && switchTab('shopify'); return; }

            // TICKET 6: Set flag that Shopify diagnostic is done and dispatch event
            try {
              window.__shopifyDiagnosticDone = true;
              // Notify other scripts (popup observer) that diagnostic finished
              document.dispatchEvent(new Event('shopify-diagnostic-done'));
            } catch(e){ console.warn('dispatch shopify-diagnostic-done failed', e); }

            // --- SHOPIFY: canonical inputs for period-based calculations ---
            const chosenPeriodDays = parseInt(document.getElementById('shopify-period')?.value || document.getElementById('period-selector')?.value || 30);

            const ordersDelivered = Number(parseInt(document.getElementById('shopify-fulfilled-orders')?.value || 0)); // Ensure ordersDelivered is a number here
            const ordersTotal = parseInt(document.getElementById('shopify-orders-tab2')?.value || 0);
            const sessions = parseInt(document.getElementById('shopify-sessions')?.value || 0);

            // TICKET B: Ensure productPriceFCFA is correctly read.
            // Changed ID from 'shopify-product-price' to 'shopify-product-price-tab2' to match existing HTML.
            const productPriceFCFA = parseFloat(
              (document.getElementById('shopify-product-price-tab2') || {}).value
            ) || 0;

            const hasUpsell = !!document.getElementById('shopify-has-upsells')?.checked;
            const hasEmailWA = !!document.getElementById('shopify-has-email-whatsapp')?.checked;

            // TICKET A & C: Read upsell percentage safely and as a fraction
            const upsellUptakePct = parsePct('shopify-upsell-percentage');

            // avgUpsellPrice should already be read; if not, read it safely:
            const avgUpsellPrice = parseFloat(
              (document.getElementById('shopify-upsell-average-price') || {}).value
            ) || 0;

            // Hidden inputs for estimated revenue (these will be recalculated below)
            const estimatedEmailRevenueHidden = Math.round(parseFloat(document.getElementById('estimated-email-revenue')?.value || 0) || 0);
            const estimatedWhatsAppRevenueHidden = Math.round(parseFloat(document.getElementById('estimated-whatsapp-revenue')?.value || 0) || 0);
            const recoveredCancellationsFCFAHidden = Math.round(parseFloat(document.getElementById('recovered-cancelled-revenue')?.value || 0) || 0);

            // --- SHOPIFY: realized vs potential ---
            // TICKET B: Fix the base revenue extra +810.
            const baseRevenueFCFA = Math.round(ordersDelivered * productPriceFCFA);

            // TICKET D: Debug logs
            console.log('DEBUG: ordersDelivered=', ordersDelivered);
            console.log('DEBUG: productPriceFCFA=', productPriceFCFA);
            console.log('DEBUG: baseRevenueFCFA=', baseRevenueFCFA);

            // TICKET A: CORRECT formula for potentialUpsellRevenueFCFA
            const potentialUpsellRevenueFCFA = Math.round(ordersDelivered * upsellUptakePct * avgUpsellPrice);
            const realizedUpsellRevenueFCFA = hasUpsell ? potentialUpsellRevenueFCFA : 0; // Preserve existing semantics

            // TICKET D: Debug logs
            console.log('DEBUG: upsellUptakePct (raw) =', (document.getElementById('shopify-upsell-percentage')||{}).value);
            console.log('DEBUG: upsellUptakePct (frac)=', upsellUptakePct);
            console.log('DEBUG: avgUpsellPrice=', avgUpsellPrice);
            console.log('DEBUG: potentialUpsellRevenueFCFA=', potentialUpsellRevenueFCFA);
            console.log('DEBUG: realizedUpsellRevenueFCFA=', realizedUpsellRevenueFCFA);


            // TICKET 1 & 4: Email/WhatsApp revenue calculation with effective list sizes and upsell uplift
            const emailListSizeRaw = parseFloat(document.getElementById('email-list-size').value) || 0;
            const whatsappListSizeRaw = parseFloat(document.getElementById('whatsapp-list-size').value) || 0;

            const effectiveEmailListSize = hasEmailWA ? emailListSizeRaw : 0;
            const effectiveWaListSize    = hasEmailWA ? whatsappListSizeRaw : 0;

            // TICKET C: Ensure percentages are used as fractions (divide by 100)
            const emailPopupRate = parsePct('email-popup-rate');
            const whatsappPopupRate = parsePct('whatsapp-popup-rate');
            const emailOpenRate = parsePct('email-open-rate');
            const emailClickFlowRate = parsePct('email-click-flow-rate');
            const emailClickCampaignRate = parsePct('email-click-campaign-rate');
            const whatsappOpenRate = parsePct('whatsapp-open-rate');
            const whatsappClickFlowRate = parsePct('whatsapp-click-flow-rate');
            const whatsappClickCampaignRate = parsePct('whatsapp-click-campaign-rate');

            const emailCampaignsPerWeek = parseFloat(document.getElementById('email-campaigns-per-week').value) || 0;
            const whatsappCampaignsPerWeek = parseFloat(document.getElementById('whatsapp-campaigns-per-week').value) || 0;

            const x = safeDivide(chosenPeriodDays, 7, 1); // Ratio for weekly campaigns

            // Base revenue for Email/WA (without upsell uplift)
            const newListEmailEst = Math.round(emailPopupRate * sessions);
            const newListWaEst    = Math.round(whatsappPopupRate * sessions);

            const baseAutomatedEmail = (effectiveEmailListSize + newListEmailEst) * emailOpenRate * emailClickFlowRate * productPriceFCFA;
            const baseAutomatedWa    = (effectiveWaListSize    + newListWaEst)    * whatsappOpenRate * whatsappClickFlowRate * productPriceFCFA;
            const baseManualEmail = (effectiveEmailListSize + newListEmailEst) * emailOpenRate * emailClickCampaignRate * productPriceFCFA * emailCampaignsPerWeek * x;
            const baseManualWa    = (effectiveWaListSize    + newListWaEst)    * whatsappOpenRate * whatsappClickCampaignRate * productPriceFCFA * whatsappCampaignsPerWeek * x;

            // Upsell uplift for Email/WA (always *computable*)
            const upsellUpliftAutomatedEmail = (effectiveEmailListSize + newListEmailEst) * emailOpenRate * emailClickFlowRate * avgUpsellPrice * upsellUptakePct;
            const upsellUpliftAutomatedWa    = (effectiveWaListSize    + newListWaEst)    * whatsappOpenRate * whatsappClickFlowRate * avgUpsellPrice * upsellUptakePct;
            const upsellUpliftManualEmail = (effectiveEmailListSize + newListEmailEst) * emailOpenRate * emailClickCampaignRate * avgUpsellPrice * upsellUptakePct * emailCampaignsPerWeek * x;
            const upsellUpliftManualWa    = (effectiveWaListSize    + newListWaEst)    * whatsappOpenRate * whatsappClickCampaignRate * avgUpsellPrice * upsellUptakePct * whatsappCampaignsPerWeek * x;

            // POTENTIAL (for display in the Email/WA card & total potential): always include upsell uplift
            const potentialAutomatedEmail = baseAutomatedEmail + upsellUpliftAutomatedEmail;
            const potentialAutomatedWa = baseAutomatedWa + upsellUpliftAutomatedWa;
            const potentialManualEmail = baseManualEmail + upsellUpliftManualEmail;
            const potentialManualWa = baseManualWa + upsellUpliftManualWa;

            const automatedFlowRevenueTotal = potentialAutomatedEmail + potentialAutomatedWa;
            const manualCampaignRevenueTotal = potentialManualEmail + potentialManualWa;
            const potentialEmailWARevenueCalculated = automatedFlowRevenueTotal + manualCampaignRevenueTotal; // This represents the full potential of E/WA

            // REALIZED (for monthly revenue): include upsell uplift only if hasUpsell
            const realizedAutomatedEmail = baseAutomatedEmail + (hasUpsell ? upsellUpliftAutomatedEmail : 0);
            const realizedAutomatedWa    = baseAutomatedWa    + (hasUpsell ? upsellUpliftAutomatedWa    : 0);
            const realizedManualEmail    = baseManualEmail    + (hasUpsell ? upsellUpliftManualEmail    : 0);
            const realizedManualWa       = baseManualWa       + (hasUpsell ? upsellUpliftManualWa       : 0);

            const realizedEmailWARevenueFCFA = hasEmailWA
              ? Math.round(realizedAutomatedEmail + realizedAutomatedWa + realizedManualEmail + realizedManualWa)
              : 0;

            // Update the hidden inputs if they exist, so canonical vars reflect actual calculation (TICKET 4)
            if (document.getElementById('estimated-email-revenue')) document.getElementById('estimated-email-revenue').value = realizedAutomatedEmail + realizedManualEmail;
            if (document.getElementById('estimated-whatsapp-revenue')) document.getElementById('estimated-whatsapp-revenue').value = realizedAutomatedWa + realizedManualWa;

            // Recalculate recovered cancellations (from the original logic)
            const cancelledOrders_calc = ordersTotal - ordersDelivered;
            const cancellationLossFCFA_calc = cancelledOrders_calc * productPriceFCFA;
            const recoveredCancellationsFCFA_calc = cancellationLossFCFA_calc * 0.2; // This was the original recovery logic
            if (document.getElementById('recovered-cancelled-revenue')) document.getElementById('recovered-cancelled-revenue').value = recoveredCancellationsFCFA_calc;

            // Now use the (potentially updated) canonical recoveredCancellationsFCFA for the final calculation
            const finalRecoveredCancellationsFCFA = Math.round(parseFloat(document.getElementById('recovered-cancelled-revenue')?.value || 0) || 0);

            // monthlyRevenue = base + realized streams (Shopify side)
            const monthlyRevenueFCFA = baseRevenueFCFA + realizedUpsellRevenueFCFA + realizedEmailWARevenueFCFA;

            // totalPotential = monthly + potentials for unchecked streams + recovered cancellations
            let totalPotentialRevenueFCFA = monthlyRevenueFCFA + finalRecoveredCancellationsFCFA;
            if (!hasUpsell) totalPotentialRevenueFCFA += potentialUpsellRevenueFCFA;
            if (!hasEmailWA) totalPotentialRevenueFCFA += Math.round(potentialEmailWARevenueCalculated); // Use calculated potential here

            // TICKET D: Debug logs
            console.log('DEBUG: realizedEmailWARevenueFCFA=', realizedEmailWARevenueFCFA);
            console.log('DEBUG: monthlyRevenueFCFA (pre final) =', baseRevenueFCFA + realizedUpsellRevenueFCFA + (realizedEmailWARevenueFCFA)); // Corrected to use realizedEmailWARevenueFCFA directly


            // expose shopify-only globals for breakdown renderer
            window.__shopify_monthlyRevenueFCFA = monthlyRevenueFCFA;
            window.__shopify_totalPotentialRevenueFCFA = totalPotentialRevenueFCFA;
            // END PATCH C

            // CPA is taken from Meta tab's calculated CPA, not input anymore
            const cpaUSD = safeNumber(parseFloat(document.getElementById('meta-cpa-display')?.textContent.replace(' USD', '')) || 0); // Adjusted to read from the display, assuming it's correctly calculated in Meta tab

            // Assume exchange rate for calculations (1 USD = 600 FCFA)
            const exchangeRate = window.FX_FCFA_PER_USD; // TICKET 1: Using global FX rate
            console.log('DEBUG: FX_FCFA_PER_USD=', exchangeRate); // TICKET D: Debug log for FX rate

            const adSpendFCFA = (parseFloat(document.getElementById('shopify-ad-spend').value) || 0) * exchangeRate; // Use direct input for ad spend
            const cpaFCFA = cpaUSD * exchangeRate;

            // Calculate metrics
            const conversionRate = safeDivide(ordersTotal, sessions) * 100;
            const cancelledOrders = ordersTotal - ordersDelivered;
            const cancellationRate = safeDivide(cancelledOrders, ordersTotal) * 100; // TICKET K: Cancellation Rate calculation
            // Calculate costs
            const productCostFCFA_direct = parseFloat(document.getElementById('shopify-product-cost').value) || 0; // supplier price
            const shippingFeeFCFA_direct = parseFloat(document.getElementById('shopify-shipping-fee').value) || 0; // supplier shipping
            const productsBought_direct = parseFloat(document.getElementById('shopify-products-bought').value) || 0;
            const deliveryFeeFCFA_direct = parseFloat(document.getElementById('shopify-delivery-fee').value) || 0; // customer delivery fee

            const shippingCostPerProductFCFA = safeDivide(shippingFeeFCFA_direct, productsBought_direct); // Shipping from supplier per product
            const actualProductCostFCFA = productCostFCFA_direct + shippingCostPerProductFCFA; // Actual product cost including supplier shipping
            const cogsFCFA = ordersDelivered * actualProductCostFCFA;
            const deliveryCostTotalFCFA = ordersDelivered * deliveryFeeFCFA_direct; // Delivery to customer total
            let fulfillmentCostFCFA_base = cogsFCFA + deliveryCostTotalFCFA; // Base fulfillment cost

            // TICKET I: adjust fulfillment cost to account for these extra orders from email/WA (using potential, not realized, for a more optimistic view of "total potential revenue")
            const estimatedEmailWAListOrders = Math.round(potentialEmailWARevenueCalculated / productPriceFCFA); // Simple estimate using full potential
            const extraCogs = estimatedEmailWAListOrders * actualProductCostFCFA;
            const extraDeliveryCost = estimatedEmailWAListOrders * deliveryFeeFCFA_direct;

            const adjustedCogsFCFA = cogsFCFA + extraCogs;
            const adjustedDeliveryCostTotalFCFA = deliveryCostTotalFCFA + extraDeliveryCost;
            const adjustedFulfillmentCostFCFA = fulfillmentCostFCFA_base + extraCogs + extraDeliveryCost; // Base + extra

            // Recompute profits using adjusted fulfillment (TICKET I)
            const grossProfitFCFA_adj = totalPotentialRevenueFCFA - adjustedFulfillmentCostFCFA; // Use totalPotentialRevenueFCFA (from Patch C)
            const netProfitFCFA_adj = grossProfitFCFA_adj - adSpendFCFA;
            const profitMarginAdj = totalPotentialRevenueFCFA > 0 ? (netProfitFCFA_adj / totalPotentialRevenueFCFA) * 100 : 0;

            // Calculate losses
            const cancellationLossFCFA = cancelledOrders * productPriceFCFA;
            const cancellationCostsFCFA = cancelledOrders * (deliveryFeeFCFA_direct + cpaFCFA);
            const potentialLossFCFA = cancellationLossFCFA + cancellationCostsFCFA;

            // Format numbers
            const formatPercent = (value) => safeNumber(value).toFixed(1) + '%';
            const formatNumber = (value) => new Intl.NumberFormat('fr-FR').format(Math.round(value));

            // PATCH D — Update Shopify displays (only Shopify nodes)
            // Render monthly and total potential in Shopify tab only
            const shopMonthlyEl = document.getElementById('shopify-monthly-revenue');
            if (shopMonthlyEl) {
                shopMonthlyEl.textContent = formatFCFA(monthlyRevenueFCFA); // Use monthlyRevenueFCFA from PATCH C
                shopMonthlyEl.dataset.raw = monthlyRevenueFCFA; // TICKET 6: Store raw value
            }

            const shopTotalEl = document.getElementById('shopify-total-pot-rev');
            if (shopTotalEl) {
                shopTotalEl.textContent = formatFCFA(totalPotentialRevenueFCFA); // Use totalPotentialRevenueFCFA from PATCH C
                shopTotalEl.dataset.raw = totalPotentialRevenueFCFA; // TICKET 6: Store raw value
            }

            // Render a compact breakdown in a Shopify-only host (optional element you should have):
            const potHost = document.getElementById('potentials-breakdown-host');
            if (potHost) {
              const rows = [];
              rows.push(`<div class="text-sm">CA actuel (ventes directes) : ${formatFCFA(baseRevenueFCFA)}</div>`);
              if (hasUpsell) rows.push(`<div class="text-sm">Upsells (réalisé) : ${formatFCFA(realizedUpsellRevenueFCFA)}</div>`);
              else rows.push(`<div class="text-sm">Upsells (potentiel) : ${formatFCFA(potentialUpsellRevenueFCFA)}</div>`);
              if (hasEmailWA) rows.push(`<div class="text-sm">Email & WhatsApp (réalisé) : ${formatFCFA(realizedEmailWARevenueFCFA)}</div>`);
              else rows.push(`<div class="text-sm">Email & WhatsApp (potentiel) : ${formatFCFA(Math.round(potentialEmailWARevenueCalculated))}</div>`); // Use calculated potential here
              rows.push(`<div class="text-sm">Cash récupéré commandes annulées : ${formatFCFA(finalRecoveredCancellationsFCFA)}</div>`);
              potHost.innerHTML = rows.join('');
              document.getElementById('shopify-potential-breakdown').style.display = 'block'; // Make sure the container is visible
            }
            // END PATCH D

            // Display results
            document.getElementById('shopify-conv-rate').textContent = formatPercent(conversionRate);
            document.getElementById('shopify-net-profit').textContent = formatFCFA(netProfitFCFA_adj); // TICKET I: Use adjusted net profit
            document.getElementById('shopify-margin').textContent = formatPercent(profitMarginAdj); // TICKET I: Use adjusted profit margin
            document.getElementById('cancelled-orders').textContent = formatNumber(cancelledOrders);
            document.getElementById('cancellation-loss').textContent = formatFCFA(cancellationLossFCFA);
            document.getElementById('fulfillment-cost').textContent = formatFCFA(adjustedFulfillmentCostFCFA); // TICKET I: Use adjusted fulfillment cost
            document.getElementById('fulfilled-orders-display').textContent = formatNumber(ordersDelivered); // Use canonical ordersDelivered
            document.getElementById('potential-loss').textContent = formatFCFA(potentialLossFCFA);
            // TICKET K: Display cancellation rate
            document.getElementById('shopify-cancellation-rate').textContent = safeNumber(cancellationRate).toFixed(2) + '%';

            // Revenue Breakdown
            let revenueBreakdownHTML = '';
            if (hasUpsell) { // Use canonical hasUpsell
                 revenueBreakdownHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-gray-50 p-4 rounded-lg dark:bg-gray-700"><p class="text-gray-600 dark:text-gray-300">Revenu avec Upsells</p><p class="text-2xl font-bold text-primary dark:text-blue-400">${formatFCFA(baseRevenueFCFA + realizedUpsellRevenueFCFA)}</p></div><div class="bg-gray-50 p-4 rounded-lg dark:bg-gray-700"><p class="text-gray-600 dark:text-gray-300">Revenu avec optimisation de (${upsellUptakePct * 100 <= 20 ? '10%' : (30 - upsellUptakePct * 100 > 0 ? `${(30 - upsellUptakePct * 100).toFixed(0)}%` : '0%')}%) upsells</p><p class="text-2xl font-bold text-secondary dark:text-green-400">${formatFCFA(baseRevenueFCFA + (ordersDelivered * avgUpsellPrice * Math.min(0.30, upsellUptakePct + (upsellUptakePct * 100 <= 20 ? 0.10 : (0.30 - upsellUptakePct))))) }</p></div></div>`;
            } else {
                const upsellPriceHypo = productPriceFCFA * 0.5;
                revenueBreakdownHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="bg-gray-50 p-4 rounded-lg dark:bg-gray-700"><p class="text-gray-600 dark:text-gray-300">Revenu en intégrant des upsells convertissant à 10%</p><p class="text-2xl font-bold text-primary dark:text-blue-400">${formatFCFA(baseRevenueFCFA + (ordersDelivered * upsellPriceHypo * 0.10))}</p></div><div class="bg-gray-50 p-4 rounded-lg dark:bg-gray-700"><p class="text-gray-600 dark:text-gray-300">Revenu en intégrant des upsells convertissant à 20%</p><p class="text-2xl font-bold text-primary dark:text-blue-400">${formatFCFA(baseRevenueFCFA + (ordersDelivered * upsellPriceHypo * 0.20))}</p></div><div class="bg-gray-50 p-4 rounded-lg dark:bg-gray-700"><p class="text-gray-600 dark:text-gray-300">Revenu en intégrant des upsells convertissant à 30%</p><p class="text-2xl font-bold text-primary dark:text-blue-400">${formatFCFA(baseRevenueFCFA + (ordersDelivered * upsellPriceHypo * 0.30))}</p></div></div>`;
            }
            document.getElementById('revenue-breakdown-content').innerHTML = revenueBreakdownHTML;

            // Email/WhatsApp Marketing Outputs
            document.getElementById('manual-campaign-revenue').textContent = formatFCFA(manualCampaignRevenueTotal);
            document.getElementById('automated-flow-revenue').textContent = formatFCFA(automatedFlowRevenueTotal);
            document.getElementById('email-whatsapp-total-revenue').textContent = formatFCFA(potentialEmailWARevenueCalculated); // Use calculated total potential

            // Performance ratings
            const emailPopupRateDisplay = parseFloat(document.getElementById('email-popup-rate').value || 10);
            const whatsappPopupRateDisplay = parseFloat(document.getElementById('whatsapp-popup-rate').value || 10);
            const effectivePopupRate = hasEmailWA ? ((emailPopupRateDisplay) + (whatsappPopupRateDisplay)) / 2 : 0;
            let popupRatingClass = 'rating-f';
            if (effectivePopupRate >= 10) popupRatingClass = 'rating-a'; else if (effectivePopupRate >= 7) popupRatingClass = 'rating-b'; else if (effectivePopupRate >= 5) popupRatingClass = 'rating-c'; else if (effectivePopupRate >= 3) popupRatingClass = 'rating-d';
            document.getElementById('popup-rating').className = `metric-card p-4 rounded-lg text-center text-white ${popupRatingClass}`;
            document.getElementById('popup-rating').innerHTML = `<p class="text-sm">Conversion Pop-up</p><p class="text-lg font-bold">Note: ${popupRatingClass.charAt(7).toUpperCase()}</p>`;

            let ctrRatingClass = 'rating-f';
            if (conversionRate >= 5) ctrRatingClass = 'rating-a'; else if (conversionRate >= 3) ctrRatingClass = 'rating-b'; else if (conversionRate >= 2) ctrRatingClass = 'rating-c'; else if (conversionRate >= 1) ctrRatingClass = 'rating-d';
            document.getElementById('ctr-rating').className = `metric-card p-4 rounded-lg text-center text-white ${ctrRatingClass}`;
            document.getElementById('ctr-rating').innerHTML = `<p class="text-sm">Taux de Conversion</p><p class="text-lg font-bold">Note: ${ctrRatingClass.charAt(7).toUpperCase()}</p>`;

            let openRateRatingClass = 'rating-f';
            const emailOpenRateInputDisplay = parseFloat(document.getElementById('email-open-rate').value || 45);
            if (emailOpenRateInputDisplay >= 50) openRateRatingClass = 'rating-a'; else if (emailOpenRateInputDisplay >= 45) openRateRatingClass = 'rating-b'; else if (emailOpenRateInputDisplay >= 40) openRateRatingClass = 'rating-c'; else if (emailOpenRateInputDisplay >= 35) openRateRatingClass = 'rating-d';
            document.getElementById('open-rate-rating').className = `metric-card p-4 rounded-lg text-center text-white ${openRateRatingClass}`;
            document.getElementById('open-rate-rating').innerHTML = `<p class="text-sm">Taux d'Ouverture Email</p><p class="text-lg font-bold">Note: ${openRateRatingClass.charAt(7).toUpperCase()}</p>`;

            // TICKET H: Upsell rating thresholds
            const upsellRevenueRatio = safeDivide(realizedUpsellRevenueFCFA, baseRevenueFCFA + realizedUpsellRevenueFCFA) * 100; // Recalculate based on new canonical values
            let upsellRatingClass = 'rating-f'; // default F (0)
            if (!hasUpsell || upsellRevenueRatio <= 0) { // Use canonical hasUpsell
              upsellRatingClass = 'rating-f';
            } else if (upsellRevenueRatio >= 25) {
              upsellRatingClass = 'rating-a';
            } else if (upsellRevenueRatio >= 15) {
              upsellRatingClass = 'rating-b';
            } else if (upsellRevenueRatio >= 7) {
              upsellRatingClass = 'rating-c';
            } else if (upsellRevenueRatio >= 1) {
              upsellRatingClass = 'rating-d';
            } else {
              upsellRatingClass = 'rating-f';
            }
            document.getElementById('upsell-rating').className = `metric-card p-4 rounded-lg text-center text-white ${upsellRatingClass}`;
            document.getElementById('upsell-rating').innerHTML = `<p class="text-sm">Performance des Upsells</p><p class="text-lg font-bold">Note: ${upsellRatingClass.charAt(7).toUpperCase()}</p>`;

            // CHANGED: copy replaced per copywriting PDF (2025-08) — Shopify Analysis Blocks
            let shopifyAnalysisHTML = '';

            // TICKET 14: Conversion Rate Analysis for Shopify
            if (conversionRate < 3) {
                shopifyAnalysisHTML += `<div class="p-4 bg-red-50 rounded-lg dark:bg-red-900/20"><h4 class="font-bold text-red-700 dark:text-red-400 collapsible-title" onclick="toggleCollapsible(this)"><span>Diagnostic : Votre Site est une Passoire à Trafic.</span><svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></h4><div class="collapsible-content">
                    <p><strong>Le Diagnostic Brut :</strong> Votre Taux de Conversion est de ${formatPercent(conversionRate)}. Sur 100 visiteurs que vous avez payés cher pour amener sur votre site, ${100 - parseFloat(conversionRate.toFixed(0))} (ou plus) repartent sans acheter.</p>
                    <p class="mt-2"><strong>Cela signifie que</strong> vous avez réussi à les faire entrer dans le magasin, mais votre offre ou votre expérience d'achat les fait fuir.</p>
                    <p class="mt-2"><strong>Causes Probables :</strong> Votre offre est faible, votre site manque de confiance (preuves sociales, design pro, branding inspirant la confiance), ou le formulaire de commande est une source de friction (compliqué ou ne fonctionne pas correctement).</p>
                    <p class="mt-2"><strong>L'Impact Financier :</strong> Votre coût d'acquisition effectif est astronomique. Vous payez pour du trafic qui ne rapporte rien. C'est le chemin le plus rapide vers un business non rentable.</p>
                </div></div>`;
            } else if (conversionRate <= 5) {
                shopifyAnalysisHTML += `<div class="p-4 bg-yellow-50 rounded-lg dark:bg-yellow-900/20 mt-4"><h4 class="font-bold text-yellow-700 dark:text-yellow-400 collapsible-title" onclick="toggleCollapsible(this)"><span>Point à Améliorer : Vous Laissez la Moitié de Vos Ventes Potentielles s'Échapper.</span><svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></h4><div class="collapsible-content">
                    <p><strong>Le Diagnostic Brut :</strong> Votre taux de conversion de ${formatPercent(conversionRate)} est correct, mais loin d'être optimisé.</p>
                    <p class="mt-2"><strong>Cela signifie que</strong> votre système fonctionne, mais il a des fuites majeures. Pour chaque client que vous obtenez, vous en perdez un autre qui était pourtant intéressé.</p>
                    <p class="mt-2"><strong>Causes Probables :</strong> Manque d'urgence, garanties faibles, ou pas assez de raisons de croire en votre produit par rapport à la concurrence.</p>
                    <p class="mt-2"><strong>L'Impact Financier :</strong> Doubler ce chiffre est possible avec les bons systèmes d'optimisation de la conversion (CRO), ce qui diviserait par deux votre coût par acquisition sans dépenser un dollar de plus en pub.</p>
                </div></div>`;
            } else {
                shopifyAnalysisHTML += `<div class="p-4 bg-green-50 rounded-lg dark:bg-green-900/20 mt-4"><h4 class="font-bold text-green-700 dark:text-green-400 collapsible-title" onclick="toggleCollapsible(this)"><span>Force: Votre Site est une Machine à Convertir.</span><svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></h4><div class="collapsible-content">
                    <p><strong>Le Diagnostic Brut :</strong> Un taux de conversion de ${formatPercent(conversionRate)} est excellent. Votre branding, votre offre et votre tunnel de vente sont alignés et efficaces.</p>
                    <p class="mt-2"><strong>Cela signifie que</strong> vous avez un système fiable pour transformer les clics en clients. C'est l'un des actifs les plus précieux de votre business.</p>
                    <p class="mt-2"><strong>La Prochaine Étape :</strong> La conversion est maîtrisée. Le prochain levier de croissance exponentielle est d'augmenter la valeur de chaque conversion c'est-à-dire pousser un client à acheter plus et à revenir plusieurs fois.</p>
                </div></div>`;
            }
            // Margin Analysis
            const marginInPocket = formatFCFA(safeNumber(1000000 * (profitMarginAdj / 100))); // TICKET I: Use adjusted margin
            if (profitMarginAdj < 40) { // TICKET I: Use adjusted margin
                shopifyAnalysisHTML += `<div class="p-4 bg-red-50 rounded-lg dark:bg-red-900/20 mt-4"><h4 class="font-bold text-red-700 dark:text-red-400 collapsible-title" onclick="toggleCollapsible(this)"><span>Alerte Rouge : Votre Marge est Étranglée. Vous ne Bâtissez pas un Actif.</span><svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></h4><div class="collapsible-content">
                    <p><strong>Le Diagnostic Brut :</strong> Votre Marge Bénéficiaire est de ${formatPercent(profitMarginAdj)}. Pour chaque 1,000,000 FCFA de CA, il ne reste que ${marginInPocket} dans votre poche après tous les coûts.</p>
                    <p class="mt-2"><strong>Cela signifie que</strong> vous avez créé un job à haute intensité, pas un business rentable et scalable. Vous travaillez pour vos fournisseurs et pour Meta, pas pour vous.</p>
                    <p class="mt-2"><strong>L'Impact Financier :</strong> Vous n'avez aucune capacité de réinvestissement pour la croissance, l'innovation ou pour construire une équipe. Votre business est en mode survie, un coup dur vous fera mettre clé sous la boutique.</p>
                </div></div>`;
            } else if (profitMarginAdj <= 60) { // TICKET I: Use adjusted margin
                shopifyAnalysisHTML += `<div class="p-4 bg-yellow-50 rounded-lg dark:bg-yellow-900/20 mt-4"><h4 class="font-bold text-yellow-700 dark:text-yellow-400 collapsible-title" onclick="toggleCollapsible(this)"><span>Point à Améliorer : Votre Marge est Correcte, mais elle Plafonne Votre Croissance.</span><svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></h4><div class="collapsible-content">
                    <p><strong>Le Diagnostic Brut :</strong> Votre Marge de ${formatPercent(profitMarginAdj)} est saine, mais elle pourrait être bien plus élevée.</p>
                    <p class="mt-2"><strong>Cela signifie que</strong> vous êtes rentable, mais vous n'exploitez pas tous les leviers à votre disposition. Vous laissez une part significative du profit sur la table.</p>
                    <p class="mt-2"><strong>L'Impact Financier :</strong> Vous pourriez scaler deux, trois fois plus vite si cette marge était optimisée. C'est la différence entre une croissance linéaire et une croissance exponentielle.</p>
                </div></div>`;
            } else {
                shopifyAnalysisHTML += `<div class="p-4 bg-green-50 rounded-lg dark:bg-green-900/20 mt-4"><h4 class="font-bold text-green-700 dark:text-green-400 collapsible-title" onclick="toggleCollapsible(this)"><span>Force: Votre Marge est le Carburant de Votre Empire.</span><svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></h4><div class="collapsible-content">
                    <p><strong>Le Diagnostic Brut :</strong> Une Marge de ${formatPercent(profitMarginAdj)} est exceptionnelle. C'est le signe d'un business fondamentalement sain et d'une offre solide.</p>
                    <p class="mt-2"><strong>Cela signifie que</strong> vous avez le cash-flow nécessaire pour dominer votre marché, innover et construire une marque durable.</p>
                    <p class="mt-2"><strong>La Prochaine Étape :</strong> Protéger et augmenter cette marge en construisant une protection autour de votre business avec un branding fort et des systèmes de rétention qui vous rendent moins dépendant des pubs.</p>
                </div></div>`;
            }

            // CORRECTED: Logic and copy for Cancellation Analysis now matches the PDF.
            const annualRecoveryHigh = formatFCFA(safeNumber(recoveredCancellationsFCFA_calc * (365 / chosenPeriodDays))); // Use calculated recovered cancellations
            const annualRecoveryMedium = formatFCFA(safeNumber((cancellationLossFCFA * 0.1) * (365 / chosenPeriodDays)));
            if (cancellationRate > 30) {
                shopifyAnalysisHTML += `<div class="p-4 bg-red-50 rounded-lg dark:bg-red-900/20 mt-4"><h4 class="font-bold text-red-700 dark:text-red-400 collapsible-title" onclick="toggleCollapsible(this)"><span>Fuite Opérationnelle : Vos Ventes Confirmées Disparaissent.</span><svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></h4><div class="collapsible-content">
                    <p><strong>Le Diagnostic Brut :</strong> ${formatPercent(cancellationRate)} de vos commandes sont annulées. Cela représente une perte sèche de ${formatFCFA(cancellationLossFCFA)}.</p>
                    <p class="mt-2"><strong>Cela signifie que</strong> votre processus post-achat est cassé ou le filtrage en front end est inexistant. Les curieux arrivent et gonflent vos chiffres, les vrais clients eux changent d'avis, ne répondent pas ou ne vous font pas assez confiance pour finaliser.</p>
                    <p class="mt-2"><strong>L'Impact Financier :</strong> C'est une double perte. Vous perdez le revenu de la vente ET le coût d'acquisition du client. C'est le poison le plus violent pour votre marge. Vous voyez de gros chiffres dans Shopify mais la réalité est différente. Récupérer ne serait-ce que 20% de ces annulations via un système de relance automatisé pourrait ajouter ${annualRecoveryHigh} à votre profit annuel, sans effort supplémentaire.</p>
                </div></div>`;
            } else if (cancellationRate >= 15) {
                shopifyAnalysisHTML += `<div class="p-4 bg-yellow-50 rounded-lg dark:bg-yellow-900/20 mt-4"><h4 class="font-bold text-yellow-700 dark:text-yellow-400 collapsible-title" onclick="toggleCollapsible(this)"><span>Point à Améliorer : Vous Laissez Filer des Millions en Annulations.</span><svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></h4><div class="collapsible-content">
                    <p><strong>Le Diagnostic Brut :</strong> Avec ${formatPercent(cancellationRate)} d'annulations, vous perdez ${formatFCFA(cancellationLossFCFA)} chaque mois.</p>
                    <p class="mt-2"><strong>Cela signifie que</strong> vos systèmes de confirmation et de suivi sont standards, mais pas optimisés. Chaque pourcentage de réduction est du profit net dans votre poche.</p>
                    <p class="mt-2"><strong>L'Impact Financier :</strong> Récupérer ne serait-ce que 10% de ces annulations via un système de relance automatisé pourrait ajouter ${annualRecoveryMedium} à votre profit annuel, sans effort supplémentaire.</p>
                </div></div>`;
            } else {
                shopifyAnalysisHTML += `<div class="p-4 bg-green-50 rounded-lg dark:bg-green-900/20 mt-4"><h4 class="font-bold text-green-700 dark:text-green-400 collapsible-title" onclick="toggleCollapsible(this)"><span>Force: Vos Opérations Post-Achat sont Solides.</span><svg class="chev w-5 h-5" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></h4><div class="collapsible-content">
                    <p><strong>Le Diagnostic Brut :</strong> Votre taux d'annulation de ${formatPercent(cancellationRate)} est très bas. Vos clients sont engagés et vont au bout du processus.</p>
                    <p class="mt-2"><strong>Cela signifie que</strong> c'est le signe d'une bonne qualification client et d'une communication claire. C'est un actif majeur.</p>
                    <p class="mt-2"><strong>La Prochaine Étape :</strong> Transformez ces clients satisfaits en acheteurs récurrents via des systèmes de fidélisation pour augmenter massivement leur Valeur Vie Client (LTV).</p>
                </div></div>`;
            }
            document.getElementById('shopify-analysis').innerHTML = shopifyAnalysisHTML;

            document.getElementById('shopify-results').classList.remove('hidden');

            // PATCH E: Call PATCH E's function
            refreshShopifyPotentialBreakdown_Shopify(chosenPeriodDays);

            // Call refreshCAC explicitly after all Shopify results are updated
            refreshCAC();

            // PATCH F — new-list-size (Shopify-only) — ensure potential shown when unchecked
            const emailPopupRate_F_raw = parseFloat(document.getElementById('email-popup-rate')?.value || 10);
            const whatsappPopupRate_F_raw = parseFloat(document.getElementById('whatsapp-popup-rate')?.value || 10);
            const estimatedNewEmail_F = Math.round(sessions * (emailPopupRate_F_raw / 100));
            const estimatedNewWhatsApp_F = Math.round(sessions * (whatsappPopupRate_F_raw / 100));
            const potentialNewTotal_F = estimatedNewEmail_F + estimatedNewWhatsApp_F;

            const existingEmail_F = parseInt(document.getElementById('email-list-size')?.value || 0);
            const existingWhats_F = parseInt(document.getElementById('whatsapp-list-size')?.value || 0);

            const newListEl = document.getElementById('new-list-size');
            if (newListEl) {
              if (hasEmailWA) { // Use canonical hasEmailWA
                const effectiveTotal = existingEmail_F + estimatedNewEmail_F + existingWhats_F + estimatedNewWhatsApp_F;
                newListEl.textContent = effectiveTotal.toLocaleString('fr-FR');
                // tooltip update (shopify-only)
                document.querySelectorAll('#new-list-size + .info-tooltip .tooltip-text').forEach(t => t.textContent = "Taille effective = taille actuelle + inscriptions estimées via popups (Email + WhatsApp).");
              } else {
                newListEl.textContent = potentialNewTotal_F.toLocaleString('fr-FR');
                // TICKET 5: Updated tooltip text for "Taille de la nouvelle liste"
                document.querySelectorAll('#new-list-size + .info-tooltip .tooltip-text').forEach(t => t.textContent = "Estimation du nombre d’abonnés que vous aurez après la période choisie (nombre actuel + inscriptions attendues via pop-ups).");
              }
            }
        }

        // Initialize the calculator with default demo values
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('meta-ad-spend').value = '800';
            document.getElementById('meta-impressions').value = '200000';
            document.getElementById('meta-clicks').value = '8000';
            document.getElementById('whatsapp-conversations').value = '1500';
            document.getElementById('whatsapp-conversions').value = '300';
            document.getElementById('whatsapp-product-price').value = '15000';
            document.getElementById('shopify-orders').value = '250';
            document.getElementById('shopify-product-price-meta').value = '15000';
            document.getElementById('shopify-ad-spend').value = '800';
            document.getElementById('shopify-sessions').value = '50000';
            document.getElementById('shopify-orders-tab2').value = '1250';
            document.getElementById('shopify-fulfilled-orders').value = '1100';
            document.getElementById('shopify-product-price-tab2').value = '15000';
            document.getElementById('shopify-product-cost').value = '8000';
            document.getElementById('shopify-shipping-fee').value = '2000';
            document.getElementById('shopify-products-bought').value = '1500';
            document.getElementById('shopify-delivery-fee').value = '1500';
            document.getElementById('email-list-size').value = '2000';
            document.getElementById('email-popup-rate').value = '8';
            document.getElementById('email-open-rate').value = '30';
            document.getElementById('email-click-flow-rate').value = '1';
            document.getElementById('email-click-campaign-rate').value = '2.5';
            document.getElementById('email-campaigns-per-week').value = '2';
            document.getElementById('whatsapp-list-size').value = '1500';
            document.getElementById('whatsapp-popup-rate').value = '12';
            document.getElementById('whatsapp-open-rate').value = '50';
            document.getElementById('whatsapp-click-flow-rate').value = '1.5';
            document.getElementById('whatsapp-click-campaign-rate').value = '3';
            document.getElementById('whatsapp-campaigns-per-week').value = '1';

            // TICKET 3: Vider un input au focus (appliquer à tous)
            const inputs = Array.from(document.querySelectorAll('#meta-tab-content input, #shopify-tab-content input'));
            inputs.forEach(el => {
              el.dataset.initialValue = el.value || '';
              el.addEventListener('focus', function () {
                if (this.value === this.dataset.initialValue) this.value = '';
              });
              el.addEventListener('blur', function () {
                if (this.value === '') this.value = this.dataset.initialValue;
              });
            });

            // TICKET 6: Masquer Email/WhatsApp UI uniquement dans l’onglet Acquisition (original logic)
            try {
                const metaContainer = document.getElementById('meta-tab-content');
                if (metaContainer) {
                    const selectorsToHide = [
                        '#email-whatsapp-question-meta', // Specific checkbox block
                        '#meta-email-whatsapp-dropdown', // Specific dropdown block
                        // General selectors, but these two IDs are specific enough
                    ];
                    selectorsToHide.forEach(sel => {
                      const el = metaContainer.querySelector(sel);
                      if (el) {
                          el.style.display = 'none';
                          // Disable inputs/selects within these hidden elements
                          if (el.querySelectorAll) el.querySelectorAll('input, select, textarea, button').forEach(i => i.disabled = true);
                      }
                    });
                }
            } catch (err) { console.warn('Hide meta-only email/whatsapp UI failed', err); }

            // TICKET H: Replace tooltip formulas with short, plain-language definitions
            const tooltipReplacements = {
                // Selector or direct text check => new tooltip text
                '[id="fulfillment-cost"] ~ .info-tooltip .tooltip-text': "Coût total pour préparer et expédier une commande.",
                // Add others as needed. Generic fallback below will catch most.
            };
            Object.entries(tooltipReplacements).forEach(([sel, text])=>{
                try {
                    const node = document.querySelector(sel);
                    if (node) node.textContent = text;
                } catch(e){}
            });
            // Generic fallback for tooltips containing mathematical operators
            document.querySelectorAll('.info-tooltip .tooltip-text').forEach(t=>{
                const s = t.textContent || '';
                if (/[=+\-*\/×]/.test(s)) { // Check for common mathematical operators
                    t.textContent = 'Description simple du concept.';
                }
                // Specific manual overrides if needed for tooltips not caught by generic regex
                if (t.textContent.includes('Revenue de Campagne manuel =')) t.textContent = "Estimation des ventes générées par vos campagnes manuelles (emails ciblés).";
                if (t.textContent.includes('Revenue de flux automatisé =')) t.textContent = "Estimation des ventes générées automatiquement par vos flows (abandon panier, welcome).";
                if (t.textContent.includes('Revenue total =')) t.textContent = "Total attendu des revenus Email & WhatsApp sur la période sélectionnée.";
                if (t.textContent.includes('Nouvelles inscriptions =')) t.textContent = "Nouvelles inscriptions attendues à partir de vos pop-ups Email & WhatsApp (estimation simple).";
                if (t.textContent.includes('Le coût total pour traiter et livrer les commandes')) t.textContent = "Coût total pour préparer et expédier une commande (produit + packaging + expédition).";
                if (t.textContent.includes('Perte liée aux Annulations + (Nombre de Commandes Annulées × (Frais de livraison + CPA))')) t.textContent = "Le manque à gagner dû aux commandes annulées et aux coûts associés.";
                if (t.textContent.includes('Le prix que vous payez pour acheter ou fabriquer un seul produit (coût des marchandises vendues - COGS).')) t.textContent = "Le prix que vous payez pour acheter ou fabriquer un seul produit.";
                if (t.textContent.includes('Les frais totaux payés pour expédier vos produits (de votre fournisseur à vous, ou de vous à l\'entrepôt).')) t.textContent = "Les frais totaux pour expédier vos produits de votre fournisseur vers vous.";
                if (t.textContent.includes('Le coût moyen de la livraison finale du colis au client (frais payés au livreur).')) t.textContent = "Le coût moyen de la livraison finale du colis au client.";
            });
        });

        // TICKET C: Ensure order analysis is above performance analysis (non-destructive)
        document.addEventListener('DOMContentLoaded', function(){
          try {
            const shopifyResults = document.getElementById('shopify-results');
            const orderBlock = document.getElementById('shopify-order-analysis');
            const headers = shopifyResults ? Array.from(shopifyResults.querySelectorAll('h3')) : [];
            let perfElem = null;
            for (let h of headers) if ((h.textContent || '').trim().toLowerCase().includes('analyse de performance')) { perfElem = h.parentElement; break; }
            if (orderBlock && perfElem) {
              shopifyResults.insertBefore(orderBlock, perfElem);
            }
          } catch(e) { console.warn('reorder order analysis failed', e); }
        });

        // TICKET G: CAC refresh & harsh copy (non-invasive; run after shopify diagnostic)
        function refreshCAC() {
          try {
            const adSpendUSD_shop = safeNumber(parseFloat(document.getElementById('shopify-ad-spend')?.value || 0));
            const ordersDelivered = safeNumber(parseInt(document.getElementById('shopify-fulfilled-orders')?.value || 0));

            const productPrice = safeNumber(parseFloat(document.getElementById('shopify-product-price-tab2')?.value || 0));
            const productSupplierPrice = safeNumber(parseFloat(document.getElementById('shopify-product-cost')?.value || 0));
            const supplierShipping = safeNumber(parseFloat(document.getElementById('shopify-shipping-fee')?.value || 0)); // Frais de Port (from supplier)
            const deliveryFee = safeNumber(parseFloat(document.getElementById('shopify-delivery-fee')?.value || 0)); // Frais de Livraison (to customer)
            const productsBought = Math.max(1, safeNumber(parseFloat(document.getElementById('shopify-products-bought')?.value || 1)));

            // CAC
            const cacUSD = ordersDelivered > 0 ? (adSpendUSD_shop / ordersDelivered) : 0;
            document.getElementById('cac-value-display').textContent = cacUSD.toFixed(2) + ' USD';

            // actual product cost (FCFA)
            const actualProductCost = productSupplierPrice + (safeDivide(supplierShipping, productsBought));

            // price to fulfil one order (FCFA)
            const rate = window.FX_FCFA_PER_USD || 600; // TICKET 1: Using global FX rate
            const cacFcfaValue = Math.round(cacUSD * rate); // cac converti en FCFA
            const priceToFulfillOrder = cacFcfaValue + actualProductCost + deliveryFee;

            // profit net per client (en FCFA)
            const profitPerCustomerFcfa = Math.round(productPrice - priceToFulfillOrder);
            document.getElementById('cac-profit-per-customer').textContent = formatFCFA(profitPerCustomerFcfa);

            // Update orders count and ad spend for the intro text
            const cacAdSpendEl = document.getElementById('cac-adspend');
            const cacOrdersCountEl = document.getElementById('cac-orders-count');
            if (cacAdSpendEl) cacAdSpendEl.textContent = (safeNumber(adSpendUSD_shop).toFixed(2) + ' USD');
            const ordersPlaced = parseInt(document.getElementById('shopify-orders-tab2')?.value || 0);
            if (cacOrdersCountEl) cacOrdersCountEl.textContent = `${ordersPlaced} commandes (${ordersDelivered} livrées)`;


            // Logic d’analyse (unchanged - should be based on new profitPerCustomer and cacFcfaValue)
            let assessment = '';
            if (ordersDelivered === 0 && ordersPlaced > 0) {
              assessment = '⛔ Aucun client livré : vous ne pouvez pas calculer un CAC réel. Vérifiez vos données de commandes expédiées.';
            } else if (ordersDelivered === 0 && ordersPlaced === 0) {
              assessment = '⛔ Aucune commande passée ou livrée : Impossible de calculer le CAC.';
            } else if (profitPerCustomerFcfa <= 0) { // Check profitPerCustomer
              assessment = `⛔ URGENT : Vous perdez de l'argent par client. Votre CAC est ${safeNumber(cacUSD).toFixed(2)} USD (≈ ${cacFcfaValue.toLocaleString('fr-FR')} FCFA). Résultat : votre business brûle de la trésorerie à chaque commande. Priorité absolue : réduire le CAC ou augmenter la marge.`;
            } else if (profitPerCustomerFcfa < (3 * cacFcfaValue)) { // Check profitPerCustomer vs 3x CAC
              assessment = `⚠️ Attention sérieuse : votre profit net par client (${formatFCFA(profitPerCustomerFcfa)}) est inférieur au seuil de sécurité (≈ 3×CAC). Cela signifie que la moindre hausse du CAC ou baisse de marge vous met en risque. Actions : augmenter la valeur par client (upsell, panier moyen), réduire coûts d'acquisition, améliorer rétention.`;
            } else {
              assessment = `✅ Bonne tenue : votre profit net par client (${formatFCFA(profitPerCustomerFcfa)}) couvre confortablement le CAC. Vous êtes positionné pour scaler de façon plus sûre (pensez upsell & fidélisation).`;
            }
            const assessmentEl = document.getElementById('cac-assessment');
            if (assessmentEl) assessmentEl.textContent = assessment;

            // Visual hint: if critical, add red border to CAC block
            const cacBlock = document.getElementById('cac-block');
            if (cacBlock) {
              if (profitPerCustomerFcfa <= 0 || profitPerCustomerFcfa < (3 * cacFcfaValue)) { // Updated conditions
                cacBlock.querySelector('.p-4').classList.add('border','border-danger','ring-2');
              } else {
                cacBlock.querySelector('.p-4').classList.remove('border','border-danger','ring-2');
              }
            }
          } catch(e){ console.warn('refreshCAC failed', e); }
        }
        document.addEventListener('DOMContentLoaded', function(){
          const startCACWatcher = () => {
            if (window.__shopifyDiagnosticDone) refreshCAC();
            ['shopify-ad-spend','shopify-orders-tab2','shopify-fulfilled-orders','shopify-product-price-tab2','shopify-product-cost','shopify-shipping-fee','shopify-delivery-fee','shopify-products-bought'].forEach(id=>{
              const el = document.getElementById(id);
              if (el) el.addEventListener('change', refreshCAC);
            });
          };
          setTimeout(startCACWatcher, 300);
        });

        // PATCH E — Replace Shopify breakdown renderer
        function refreshShopifyPotentialBreakdown_Shopify(chosenPeriodDays) {
          try {
            const chosen = chosenPeriodDays || parseInt(document.getElementById('shopify-period')?.value || 30);
            const currentMonthly = Math.round(window.__shopify_monthlyRevenueFCFA || 0);
            const totalPotential = Math.round(window.__shopify_totalPotentialRevenueFCFA || 0);
            const leaving = Math.max(0, totalPotential - currentMonthly);

            const horizons = {7:[30,90,365],30:[90,365],90:[365],365:[]}[chosen] || [];

            const host = document.getElementById('shopify-potential-breakdown');
            if (!host) return;

            // readable in light/dark
            host.className = "mt-3 p-4 bg-indigo-50 rounded-lg text-gray-900 dark:bg-indigo-900/30 dark:text-white";

            let html = `<p class="text-lg font-semibold">Résumé :</p>`;
            html += `<p class="mt-2">Aujourd’hui, vous encaissez <strong>${formatFCFA(currentMonthly)}</strong> sur <strong>${chosen} jours</strong>.</p>`;
            html += `<p class="mt-2">Avec vos upsells, votre rétention et vos systèmes, votre potentiel réel est de <strong>${formatFCFA(totalPotential)}</strong>.</p>`;
            html += `<p class="mt-2">➡️ Ce que cela veut dire : vous laissez déjà ~<strong>${formatFCFA(leaving)}</strong> sur la table.</p>`;

            if (horizons.length) {
              html += `<div class="mt-3"><p class="font-medium">Projection :</p><ul class="list-disc pl-5 mt-2">`;
              horizons.forEach(h => {
                const projected = Math.round(leaving * (h/chosen));
                html += `<li>En ${h} jours : <strong>${formatFCFA(projected)}</strong></li>`;
              });
              html += `</ul></div>`;
            }

            html += `<p class="mt-3"><em>Chaque jour sans action, vous payez cette facture invisible. Voilà votre second chiffre d'affaires.</em></p>`;

            // TICKET 2: Removed the redundant pitch paragraph and button here.
            // --- promotional pitch removed per instruction (non-destructive: placeholder kept commented) ---
            // html += `<div class="mt-4 p-3 bg-white rounded dark:bg-gray-800">`;
            // html += `<p class="mb-3">... promotional pitch ...</p>`;
            // html += `<a class="inline-block px-5 py-2 bg-primary text-white rounded" href="https://subscribepage.io/momentummedia" target="_blank" rel="noopener">DÉCOUVRIR COMBIEN JE PERDS</a>`;
            // html += `</div>`;


            host.innerHTML = html;
          } catch (e) {
            console.warn('refreshShopifyPotentialBreakdown_Shopify', e);
          }
        }

        function getCurrentResultsForShare() {
          // TICKET 6: build minimal results object used for share
          const actual = Number(document.getElementById('shopify-monthly-revenue')?.dataset.raw || 0);
          const potential = Number(document.getElementById('shopify-total-pot-rev')?.dataset.raw || 0);
          const chosenDays = Number(document.getElementById('shopify-period')?.value || 30);
          const left = Math.max(0, potential - actual);
          return { actual, potential, left, chosenDays, ts: Date.now() };
        }

        function setupShareButtons() {
          // TICKET 6: Setup share buttons
          const native = document.getElementById('btn-share-native');
          const wa = document.getElementById('btn-share-wa');
          const copy = document.getElementById('btn-copy-link');

          if (native) native.addEventListener('click', async () => openNativeShare(getCurrentResultsForShare()));
          if (wa) wa.addEventListener('click', () => {
            const res = getCurrentResultsForShare();
            // send with compact inline summary + link
            const text = `Mon CA: ${formatFCFA(res.actual)}. Potentiel: ${formatFCFA(res.potential)}. Je laisse ${formatFCFA(res.left)}. Détails: ${generateSharePayload(res)}`;
            window.open('https://wa.me/?text=' + encodeURIComponent(text), '_blank');
          });
          if (copy) copy.addEventListener('click', async () => {
            const url = generateSharePayload(getCurrentResultsForShare());
            try { await navigator.clipboard.writeText(url); alert('Lien copié.'); }
            catch(e) { prompt('Copiez ce lien:', url); }
          });
        }


        function parseSharedPayloadOnLoad(renderSharedCallback) {
          // TICKET 7: Parse `?share=` on load & render shared results
          try {
            const urlParams = new URLSearchParams(window.location.search);
            const sh = urlParams.get('share');
            if (!sh) return false;
            const json = base64UrlDecode(sh);
            const obj = JSON.parse(json);
            if (typeof renderSharedCallback === 'function') {
              renderSharedCallback(obj);
            } else {
              // fallback: display a banner summary
              const host = document.getElementById('shared-results-banner'); // Use dedicated banner host
              if (host) {
                host.innerHTML = `<div class="p-3 rounded border bg-yellow-50 dark:bg-yellow-900/20 dark:text-yellow-300 text-yellow-900">
                  <p class="font-semibold">Vous consultez un résultat partagé :</p>
                  <p>Potentiel : ${formatFCFA(obj.potential)}</p>
                  <p>CA : ${formatFCFA(obj.actual)}</p>
                </div>`;
              }
            }
            return true;
          } catch (e) {
            console.warn('parseSharedPayloadOnLoad failed', e);
            return false;
          }
        }


        // Global DOMContentLoaded handler
        document.addEventListener('DOMContentLoaded', () => {
          initDarkMode(); // Keep existing dark mode init
          document.getElementById('dark-mode-toggle').addEventListener('click', toggleDarkMode); // Keep existing dark mode toggle

          // TICKET 1: Call FX fetch on load
          fetchFxUsdToXof().then(rate => {
            console.info('FX USD→XOF:', rate);
            // TICKET 3: trigger any dependent recalcs if already executed
            const shopifyTabContent = document.getElementById('shopify-tab-content');
            if (shopifyTabContent && !shopifyTabContent.classList.contains('hidden') && typeof calculateShopifyResults === 'function') {
                calculateShopifyResults();
            }
            // TICKET 2: and update the small badge (if present)
            const el = document.getElementById('fx-rate-badge');
            if (el) el.textContent = `1 USD ≈ ${new Intl.NumberFormat('fr-FR').format(Math.round(rate))} FCFA`;
          });

          // TICKET 3: Vider un input au focus (appliquer à tous) - original logic
          const inputs = Array.from(document.querySelectorAll('#meta-tab-content input, #shopify-tab-content input'));
          inputs.forEach(el => {
            el.dataset.initialValue = el.value || '';
            el.addEventListener('focus', function () {
              if (this.value === this.dataset.initialValue) this.value = '';
            });
            el.addEventListener('blur', function () {
              if (this.value === '') this.value = this.dataset.initialValue;
            });
          });

          // TICKET 6: Masquer Email/WhatsApp UI uniquement dans l’onglet Acquisition - original logic
          try {
              const metaContainer = document.getElementById('meta-tab-content');
              if (metaContainer) {
                  const selectorsToHide = [
                      '#email-whatsapp-question-meta',
                      '#meta-email-whatsapp-dropdown',
                  ];
                  selectorsToHide.forEach(sel => {
                    const el = metaContainer.querySelector(sel);
                    if (el) {
                        el.style.display = 'none';
                        if (el.querySelectorAll) el.querySelectorAll('input, select, textarea, button').forEach(i => i.disabled = true);
                    }
                  });
              }
          } catch (err) { console.warn('Hide meta-only email/whatsapp UI failed', err); }

          // TICKET H: Replace tooltip formulas with short, plain-language definitions - original logic
          const tooltipReplacements = {
              '[id="fulfillment-cost"] ~ .info-tooltip .tooltip-text': "Coût total pour préparer et expédier une commande.",
          };
          Object.entries(tooltipReplacements).forEach(([sel, text])=>{
              try {
                  const node = document.querySelector(sel);
                  if (node) node.textContent = text;
              } catch(e){}
          });
          document.querySelectorAll('.info-tooltip .tooltip-text').forEach(t=>{
              const s = t.textContent || '';
              if (/[=+\-*\/×]/.test(s)) {
                  t.textContent = 'Description simple du concept.';
              }
              if (t.textContent.includes('Revenue de Campagne manuel =')) t.textContent = "Estimation des ventes générées par vos campagnes manuelles (emails ciblés).";
              if (t.textContent.includes('Revenue de flux automatisé =')) t.textContent = "Estimation des ventes générées automatiquement par vos flows (abandon panier, welcome).";
              if (t.textContent.includes('Revenue total =')) t.textContent = "Total attendu des revenus Email & WhatsApp sur la période sélectionnée.";
              if (t.textContent.includes('Nouvelles inscriptions =')) t.textContent = "Nouvelles inscriptions attendues à partir de vos pop-ups Email & WhatsApp (estimation simple).";
              if (t.textContent.includes('Le coût total pour traiter et livrer les commandes')) t.textContent = "Coût total pour préparer et expédier une commande (produit + packaging + expédition).";
              if (t.textContent.includes('Perte liée aux Annulations + (Nombre de Commandes Annulées × (Frais de livraison + CPA))')) t.textContent = "Le manque à gagner dû aux commandes annulées et aux coûts associés.";
              if (t.textContent.includes('Le prix que vous payez pour acheter ou fabriquer un seul produit (coût des marchandises vendues - COGS).')) t.textContent = "Le prix que vous payez pour acheter ou fabriquer un seul produit.";
              if (t.textContent.includes('Les frais totaux payés pour expédier vos produits (de votre fournisseur à vous, ou de vous à l\'entrepôt).')) t.textContent = "Les frais totaux pour expédier vos produits de votre fournisseur vers vous.";
              if (t.textContent.includes('Le coût moyen de la livraison finale du colis au client (frais payés au livreur).')) t.textContent = "Le coût moyen de la livraison finale du colis au client.";
          });

          // TICKET 6: Setup share buttons
          setupShareButtons();

          // TICKET 7: Parse shared payload on load
          parseSharedPayloadOnLoad(function(sharedObj){
            const host = document.getElementById('shared-results-banner');
            if (!host) return;
            host.innerHTML = `<div class="p-4 rounded-md border border-indigo-300 bg-indigo-50 text-indigo-900 dark:bg-indigo-900/30 dark:text-indigo-200">
              <p class="font-semibold text-lg mb-2">Résultat partagé du Scanner de Profit E-com</p>
              <p>CA Actuel : <span class="font-bold">${formatFCFA(sharedObj.actual)}</span></p>
              <p>Potentiel Total : <span class="font-bold">${formatFCFA(sharedObj.potential)}</span></p>
              <p>Potentiel laissé : <span class="font-bold">${formatFCFA(sharedObj.left)}</span></p>
              <p class="text-sm text-gray-700 dark:text-gray-400 mt-2">Période d'analyse : ${sharedObj.chosenDays} jours</p>
              <p class="text-sm text-gray-700 dark:text-gray-400">Partagé le : ${new Date(sharedObj.ts).toLocaleDateString('fr-FR')}</p>
            </div>`;
            // Switch to Shopify tab to show results if not already there
            switchTab('shopify');
          });
        });
    </script>
    <!-- MailerLite Universal (existing snippet) -->
    <script>
      (function(w,d,e,u,f,l,n){w[f]=w[f]||function(){(w[f].q=w[f].q||[]).push(arguments);},l=d.createElement(e),l.async=1,l.src=u,n=d.getElementsByTagName(e)[0],n.parentNode.insertBefore(l,n);})
      (window,document,'script','https://assets.mailerlite.com/js/universal.js','ml');
      ml('account', '1274079');
    </script>
    <!-- End MailerLite Universal -->
    <script>
// ---------- Popup MailerLite : robust trigger (non-destructif) ----------
(function(){
  const POPUP_ID = 'mXMWdM'; // mailerlite popup id
  const PREVIEW_URL = 'https://preview.mailerlite.io/forms/1274079/164160964725311195/share';
  const STORAGE_KEY = 'ml_popup_shown_shopify_v2';
  const STORAGE_TTL_MS = 30 * 24 * 60 * 60 * 1000; // TTL persistent : 30 days
  let observer = null;

  // Helper: has been shown recently?
  function hasShownRecently() {
    try {
      // session-level quick block
      if (sessionStorage.getItem(STORAGE_KEY + '_session')) return true;
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return false;
      const obj = JSON.parse(raw);
      if (!obj || !obj.ts) return false;
      const age = Date.now() - Number(obj.ts || 0);
      return age < STORAGE_TTL_MS;
    } catch (e) { return false; }
  }

  function markAsShown() {
    try {
      sessionStorage.setItem(STORAGE_KEY + '_session', '1');
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ ts: Date.now() }));
    } catch(e){ /* ignore */ }
  }

  // robust CTA finder: tries common selectors & heuristics
  function findShopifyCTA() {
    const shopifyArea = document.getElementById('shopify-results') || document.getElementById('shopify-tab-content');
    if (!shopifyArea) return null;
    // try known calendar / subscribe links first
    let link = shopifyArea.querySelector("a[href*='calendly.com'], a[href*='subscribepage.io'], a[href*='preview.mailerlite.io']");
    if (link) return link;
    // look for exact text matches (normalized)
    const btns = Array.from(shopifyArea.querySelectorAll('a, button'));
    const keywords = ['débloquer', 'revenu', 'découvrir', 'réserver', 'audit', 'calendly'];
    for (const b of btns) {
      const txt = (b.textContent || '').trim().toLowerCase();
      if (!txt) continue;
      for (const kw of keywords) {
        if (txt.includes(kw)) return b;
      }
    }
    // fallback: first big CTA-looking element
    return shopifyArea.querySelector('a[class*="btn"], button[class*="btn"], a, button') || null;
  }

  // show popup with fallback
  function showPopup() {
    try {
      if (typeof ml !== 'undefined' && POPUP_ID) {
        ml('show', POPUP_ID, true);
      } else {
        window.open(PREVIEW_URL, '_blank');
      }
      markAsShown();
    } catch (e) {
      try { window.open(PREVIEW_URL, '_blank'); markAsShown(); } catch(e2){ console.warn('Popup fallback failed', e2); }
    }
  }

  // attach observer to CTA
  function initObserverOnCTA() {
    try {
      if (hasShownRecently()) return false;
      // require diagnostic done
      if (!window.__shopifyDiagnosticDone) return false;

      const cta = findShopifyCTA();
      if (!cta) return false;

      // Avoid duplicate attachment
      if (cta.__mlObserverAttached) return true;

      // If CTA is in the viewport already, show immediately (but still mark)
      const rect = cta.getBoundingClientRect();
      const inViewport = rect.top >= 0 && rect.bottom <= (window.innerHeight || document.documentElement.clientHeight);
      if (inViewport) {
        showPopup();
        cta.__mlObserverAttached = true;
        return true;
      }

      observer = new IntersectionObserver((entries) => {
        for (const entry of entries) {
          if (entry.isIntersecting && entry.intersectionRatio >= 0.6 && window.__shopifyDiagnosticDone && !hasShownRecently()) {
            showPopup();
            if (observer) observer.disconnect();
            entry.target.__mlObserverAttached = true;
          }
        }
      }, { threshold: [0.6], root: null, rootMargin: '0px' });

      observer.observe(cta);
      cta.__mlObserverAttached = true;

      // also mark as shown if user clicks CTA (so popup won't reappear)
      const onClick = () => { markAsShown(); cta.removeEventListener('click', onClick); };
      cta.addEventListener('click', onClick);

      return true;
    } catch (e) {
      console.warn('initObserverOnCTA error', e);
      return false;
    }
  }

  // retry attach (Shopify results might be rendered async)
  let tries = 0;
  const timer = setInterval(() => {
    tries++;
    const ok = initObserverOnCTA();
    if (ok || tries > 60) clearInterval(timer);
  }, 300);

  // Ensure we try again when switching tab to shopify
  const originalSwitch = window.switchTab;
  window.switchTab = function(tabName) {
    try { if (typeof originalSwitch === 'function') originalSwitch(tabName); } catch(e){}
    if (tabName === 'shopify') setTimeout(initObserverOnCTA, 300);
  };

  // If calculateShopifyResults sets window.__shopifyDiagnosticDone=true, then initObserver will trigger (we also call init here)
  document.addEventListener('shopify-diagnostic-done', () => setTimeout(initObserverOnCTA, 150));
  // and also try on DOMContentLoaded
  document.addEventListener('DOMContentLoaded', () => setTimeout(initObserverOnCTA, 600));
})();
    </script>
</body>
</html>
